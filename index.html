<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تطبيق قطرة أمل</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* التنسيقات العامة */
    .btn-update-date {
      background-color: #2e7d32;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn-update-date:hover {
      background-color: #1b5e20;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Arial', sans-serif; background: #f0f0f0; margin: 0; padding: 0; }
    header { background-color: #b30000; color: white; text-align: center; padding: 15px; font-size: 20px; display: none; }
    nav { display: none; flex-wrap: wrap; justify-content: space-around; background-color: #ffcccc; padding: 10px; }
    nav button { 
      background-color: #b30000; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      padding: 10px 20px; 
      margin: 5px; 
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section { display: none; padding: 20px; }
    .active { display: block; }
    input, select, button, textarea { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; }
    .field-label { color: #b30000; font-size: 14px; margin-top: 10px; display: flex; align-items: center; gap: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    td, th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 10px; text-align: center; }
    thead { background-color: #b30000; color: white; }
    tbody tr { border: 2px solid #b30000; margin-bottom: 10px; }
    .input-icon { position: relative; }
    .input-icon i { 
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #b30000;
    }
    .input-icon input, .input-icon select { padding-right: 40px !important; }
    
    /* محاذاة أرقام الهاتف والواتساب لليمين */
    .phone-input, .whatsapp-input {
      direction: ltr;
      text-align: right;
      font-family: monospace;
    }
    
    /* مؤشر التحميل */
    #loadingIndicator {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    /* أنماط جديدة للتحسينات */
    .stars-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      font-size: 24px;
    }
    
    .stars-container i {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .donor-rating {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    
    .availability-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .available { background-color: #e8f5e9; color: #2e7d32; }
    .busy { background-color: #fff8e1; color: #ff8f00; }
    .away { background-color: #e3f2fd; color: #1565c0; }
    .unavailable { background-color: #ffebee; color: #c62828; }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tr { margin-bottom: 15px; border: 2px solid #b30000; padding: 10px; border-radius: 10px; background-color: #fff; }
      td { text-align: right; padding-right: 50%; position: relative; border: none; border-bottom: 1px solid #eee; }
      td::before { content: attr(data-label); position: absolute; right: 10px; top: 10px; font-weight: bold; color: #b30000; }
      td:last-child { border-bottom: none; }
    }
    
    .popup-message, .update-date-popup { 
      display: none; 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: white; 
      padding: 20px; 
      border: 2px solid red; 
      border-radius: 10px; 
      z-index: 1000; 
      text-align: center; 
      max-width: 90%;
      width: 400px;
    }
    
    .popup-message.active, .update-date-popup.active { display: block; }
    
    .popup-icon {
      font-size: 40px;
      margin-bottom: 15px;
    }
    
    .success-icon { color: #2e7d32; }
    .error-icon { color: #b30000; }
    .warning-icon { color: #ff8f00; }
    
    button i { margin-left: 8px; }
    
    #passwordError {
      color: #b30000;
      font-size: 14px;
      margin: 10px 0;
      display: none;
      text-align: center;
      font-weight: bold;
    }

    /* أنماط قسم الترحيب الجديد */
    #welcome {
      text-align: center;
      padding: 20px;
      max-width: 100%;
      margin: 0 auto;
    }
    #welcome h1 {
      color: #b30000;
      margin-bottom: 30px;
      font-size: 28px;
    }
    #welcome .welcome-content {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: right;
    }
    #welcome h2 {
      color: #b30000;
      font-size: 24px;
      margin-bottom: 15px;
    }
    #welcome h3 {
      color: #b30000;
      margin-top: 25px;
      font-size: 20px;
    }
    #welcome p {
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    #welcome ul {
      text-align: right;
      font-size: 17px;
      line-height: 1.8;
      list-style-type: none;
      padding: 0;
    }
    #welcome li {
      margin-bottom: 10px;
      padding-right: 10px;
    }
    #welcome .quote-box {
      margin: 30px 0;
      padding: 15px;
      background: #ffebee;
      border-radius: 8px;
      border-right: 4px solid #b30000;
      text-align: center;
    }
    #welcome .quote-box i {
      color: #b30000;
      font-size: 24px;
      margin-bottom: 10px;
    }
    #welcome .quote-box p {
      font-style: italic;
      font-size: 16px;
      margin: 0;
    }
    #btn-start-app {
      background-color: #b30000;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 30px;
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin: 20px auto;
      transition: background-color 0.3s;
    }
    #btn-start-app:hover {
      background-color: #8c0000;
    }
    
    /* أنماط تسجيل الدخول */
    .login-container {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    
    .login-container h2 {
      color: #b30000;
      text-align: center;
      margin-bottom: 25px;
    }
    
    .login-options {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    .login-options button {
      width: 48%;
      padding: 10px;
    }
    
    #btn-login {
      background-color: #b30000;
    }
    
    #btn-register {
      background-color: #2e7d32;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      color: white;
    }
    
    .user-profile img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* تحسينات للجوال */
    @media (max-width: 768px) {
      .login-container, .popup-message {
          width: 90%;
          padding: 15px;
      }
      
      button {
          padding: 12px 15px;
          font-size: 16px;
      }
      
      input, select, textarea {
          font-size: 16px;
      }

      nav button {
          padding: 8px 12px;
          font-size: 14px;
      }
    }
  </style>
   <!-- jsPDF and AutoTable plugin -->
   <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- CryptoJS for password hashing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>

<!-- مؤشر التحميل -->
<div id="loadingIndicator">
  <i class="fas fa-spinner fa-spin fa-3x"></i>
  <p>جاري المعالجة...</p>
</div>

<!-- قسم تسجيل الدخول -->
<div id="loginSection" class="section active">
  <div class="login-container">
    <h2><i class="fas fa-tint"></i> تسجيل الدخول</h2>
    
    <div class="input-icon">
      <i class="fas fa-phone"></i>
      <input type="tel" id="loginPhone" class="phone-input" placeholder="رقم الهاتف" inputmode="numeric" dir="ltr">
    </div>
    
    <div class="input-icon">
      <i class="fas fa-lock"></i>
      <input type="password" id="loginPassword" placeholder="كلمة المرور">
    </div>
    
    <p id="loginError" style="color: #b30000; text-align: center; display: none;"></p>
    
    <button id="btn-login-submit"><i class="fas fa-sign-in-alt"></i> دخول</button>
    
    <div class="login-options">
      <button id="btn-go-to-register"><i class="fas fa-user-plus"></i> تسجيل جديد</button>
      <button id="btn-reset-password"><i class="fas fa-key"></i> استعادة كلمة المرور</button>
    </div>
  </div>
</div>

<!-- قسم التسجيل -->
<div id="registerSection" class="section">
  <div class="login-container">
    <h2><i class="fas fa-user-plus"></i> تسجيل حساب جديد</h2>
    
    <div class="input-icon">
      <i class="fas fa-user"></i>
      <input type="text" id="registerName" placeholder="الاسم الكامل">
    </div>
    
    <div class="input-icon">
      <i class="fas fa-phone"></i>
      <input type="tel" id="registerPhone" class="phone-input" placeholder="رقم الهاتف" inputmode="numeric" dir="ltr">
    </div>
    
    <div class="input-icon">
      <i class="fas fa-lock"></i>
      <input type="password" id="registerPassword" placeholder="كلمة المرور (6 أحرف على الأقل)">
    </div>
    
    <div class="input-icon">
      <i class="fas fa-lock"></i>
      <input type="password" id="registerConfirmPassword" placeholder="تأكيد كلمة المرور">
    </div>
    
    <p id="registerError" style="color: #b30000; text-align: center; display: none;"></p>
    
    <button id="btn-register-submit"><i class="fas fa-save"></i> تسجيل</button>
    <button id="btn-go-to-login"><i class="fas fa-sign-in-alt"></i> لديك حساب؟ سجل دخول</button>
  </div>
</div>

<!-- قسم الترحيب -->
<div id="welcome" class="section">
  <div style="max-width: 800px; margin: 0 auto;">
    <h1>
      <i class="fas fa-tint"></i> مرحبًا بكم في تطبيق قطرة أمل
    </h1>
    
    <div class="welcome-content">
      <h2>هدف التطبيق</h2>
      <p>
        تطبيق "قطرة أمل" هو مبادرة إنسانية تهدف إلى تسهيل عملية البحث عن المتبرعين بالدم وتوفير وسيلة اتصال سريعة بين المحتاجين والمتبرعين. 
        نسعى من خلال هذا التطبيق إلى إنقاذ حياة المرضى والمصابين الذين يحتاجون إلى نقل الدم بشكل عاجل.
      </p>
      
      <h3>كيف يعمل التطبيق؟</h3>
      <ul>
        <li><i class="fas fa-check-circle" style="color: #2e7d32;"></i> تسجيل المتبرعين الراغبين في المساعدة</li>
        <li><i class="fas fa-check-circle" style="color: #2e7d32;"></i> البحث عن المتبرعين حسب فصيلة الدم والموقع</li>
        <li><i class="fas fa-check-circle" style="color: #2e7d32;"></i> التواصل المباشر مع المتبرعين عبر الهاتف أو الواتساب</li>
        <li><i class="fas fa-check-circle" style="color: #2e7d32;"></i> تحديث بيانات المتبرعين بسهولة</li>
        <li><i class="fas fa-check-circle" style="color: #2e7d32;"></i> نظام تنبيهات للمتبرعين في حالات الطوارئ</li>
        <li><i class="fas fa-check-circle" style="color: #2e7d32;"></i> تقييم المتبرعين لتعزيز الثقة في النظام</li>
      </ul>
    </div>
    
    <button id="btn-start-app">
      <i class="fas fa-sign-in-alt"></i> الدخول إلى التطبيق
    </button>
    
    <p style="margin-top: 5px; font-size: 14px; color: #666; line-height: 1.4;">
      <i class="fas fa-info-circle"></i> مصمم الموقع نبيل سالم اليافعي<br>
      <p><a href="https://wa.me/966511479262" target="_blank">00966511479262 أضغط للتواصل مباشرة</a></p>
    </p>
  </div>
</div>

<header>
  <div style="display: flex; align-items: center; justify-content: space-between;">
    <div>
      <i class="fas fa-tint"></i> تطبيق قطرة أمل ... قطرة أمل تنقذ حياة
    </div>
    <div id="userProfile" class="user-profile" style="display: none;">
      <span id="userName"></span>
      <button id="btn-logout" style="background: none; border: none; color: white; cursor: pointer;">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </div>
</header>
<p style="font-size: 17px; color: #333; line-height: 1.3; margin: 5px 0; font-weight: 600; text-align: center; display: none;">
  <i class="fas fa-info-circle"></i> تم تصميم هذا الموقع لتسهيل عملية البحث عن المتبرعين بالدم، وسهولة التواصل مع المتبرعين.
</p>

<nav>
  <button id="btn-show-register"><i class="fas fa-user-plus"></i> تسجيل متبرع جديد</button>
  <button id="btn-show-search"><i class="fas fa-search"></i> بحث عن متبرع</button>
  <button id="btn-send-emergency"><i class="fas fa-bell"></i> تنبيه طارئ</button>
  <button id="btn-show-suggestions"><i class="fas fa-lightbulb"></i> اقتراحات</button>
</nav>

<div id="register" class="section">
  <h3 style="margin-bottom: 4px;"><i class="fas fa-user-plus"></i> تسجيل متبرع جديد</h3>
  <p style="font-size: 15px; color: #b71c1c; line-height: 1.2; margin-top: 0; font-weight: 500;">
    <i class="fas fa-info-circle"></i> الرجاء تعبئة البيانات المطلوبة
  </p>
  
  <div class="input-icon">
    <i class="fas fa-user"></i>
    <input type="text" id="donorName" placeholder="الاسم">
  </div>
  
  <div class="input-icon">
    <i class="fas fa-phone"></i>
    <input type="tel" id="donorPhone" class="phone-input" placeholder="رقم الهاتف" inputmode="numeric" dir="ltr">
  </div>
  
  <div class="input-icon">
    <i class="fab fa-whatsapp"></i>
    <input type="tel" id="donorWhatsapp" class="whatsapp-input" placeholder="967712345678 (اختياري)" inputmode="numeric" dir="ltr">
  </div>
  
  <div class="input-icon">
    <i class="fas fa-city"></i>
    <input type="text" id="donorCity" placeholder="المحافظة">
  </div>
  
  <div class="input-icon">
    <i class="fas fa-map-marker-alt"></i>
    <input type="text" id="donorArea" placeholder="المديرية">
  </div>
  
  <div class="input-icon">
    <i class="fas fa-home"></i>
    <input type="text" id="donorLocation" placeholder="مكان السكن (اختياري)">
  </div>
  
  <label class="field-label">
    <i class="fas fa-calendar-alt"></i> تاريخ آخر تبرع (اختياري)
  </label>
  <div class="input-icon">
    <i class="far fa-calendar"></i>
    <input type="date" id="donorLastDate">
  </div>
  
  <label class="field-label">
    <i class="fas fa-tint"></i> فصيلة الدم
  </label>
  <div class="input-icon">
    <i class="fas fa-chevron-down"></i>
    <select id="donorBlood">
      <option disabled selected value="">اختر فصيلة الدم</option>
      <option>+A</option><option>-A</option>
      <option>+B</option><option>-B</option>
      <option>+AB</option><option>-AB</option>
      <option>+O</option><option>-O</option>
    </select>
  </div>
  
  <label class="field-label">
    <i class="fas fa-bell"></i> تلقي تنبيهات الطوارئ
  </label>
  <div class="input-icon">
    <i class="fas fa-chevron-down"></i>
    <select id="donorNotification">
      <option value="enabled">نعم، أريد تلقي التنبيهات</option>
      <option value="disabled">لا، لا أريد تلقي التنبيهات</option>
    </select>
  </div>
  
  <label class="field-label">
    <i class="fas fa-user-clock"></i> حالة التوفر الحالية
  </label>
  <div class="input-icon">
    <i class="fas fa-chevron-down"></i>
    <select id="donorAvailability">
      <option value="available">متاح للتبرع</option>
      <option value="busy">مشغول حالياً</option>
      <option value="away">خارج المدينة</option>
      <option value="unavailable">غير متاح</option>
    </select>
  </div>
  
  <button id="btn-add-donor"><i class="fas fa-save"></i> تسجيل</button>
</div>

<div id="edit" class="section">
  <h3><i class="fas fa-edit"></i> تعديل بيانات متبرع</h3>
  <div class="input-icon">
    <i class="fas fa-search"></i>
    <input type="text" id="editSearchInput" placeholder="ابحث باسم المتبرع أو رقمه">
  </div>
  <button id="btn-search-donor-edit"><i class="fas fa-search"></i> بحث</button>
  
  <div id="editSection" style="display:none;">
    <p><i class="fas fa-user-edit"></i> جاري تعديل بيانات المتبرع صاحب المعرف: <span id="editingDonorId"></span></p>
    
    <div class="input-icon">
      <i class="fas fa-user"></i>
      <input type="text" id="editNewName" placeholder="الاسم الكامل">
    </div>
    
    <div class="input-icon">
      <i class="fas fa-phone"></i>
      <input type="tel" id="editPhone" class="phone-input" placeholder="رقم الهاتف" dir="ltr">
    </div>
    
    <label class="field-label">
      <i class="fab fa-whatsapp"></i> رقم الواتساب (اختياري)
    </label>
    <div class="input-icon">
      <i class="fab fa-whatsapp"></i>
      <input type="tel" id="editWhatsapp" class="whatsapp-input" placeholder="967712345678 (اختياري)" dir="ltr">
    </div>
    
    <div class="input-icon">
      <i class="fas fa-city"></i>
      <input type="text" id="editCity" placeholder="المحافظة">
    </div>
    
    <div class="input-icon">
      <i class="fas fa-map-marker-alt"></i>
      <input type="text" id="editArea" placeholder="المديرية">
    </div>
    
    <div class="input-icon">
      <i class="fas fa-home"></i>
      <input type="text" id="editLocation" placeholder="مكان السكن (اختياري)">
    </div>
    
    <label class="field-label">
      <i class="fas fa-calendar-alt"></i> تاريخ آخر تبرع
    </label>
    <div class="input-icon">
      <i class="far fa-calendar"></i>
      <input type="date" id="editLastDate">
    </div>
    
    <label class="field-label">
      <i class="fas fa-tint"></i> فصيلة الدم
    </label>
    <div class="input-icon">
      <i class="fas fa-chevron-down"></i>
      <select id="editBlood">
        <option>+A</option><option>-A</option>
        <option>+B</option><option>-B</option>
        <option>+AB</option><option>-AB</option>
        <option>+O</option><option>-O</option>
      </select>
    </div>
    
    <label class="field-label">
      <i class="fas fa-bell"></i> تلقي تنبيهات الطوارئ
    </label>
    <div class="input-icon">
      <i class="fas fa-chevron-down"></i>
      <select id="editNotification">
        <option value="enabled">نعم، أريد تلقي التنبيهات</option>
        <option value="disabled">لا، لا أريد تلقي التنبيهات</option>
      </select>
    </div>
    
    <label class="field-label">
      <i class="fas fa-user-clock"></i> حالة التوفر الحالية
    </label>
    <div class="input-icon">
      <i class="fas fa-chevron-down"></i>
      <select id="editAvailability">
        <option value="available">متاح للتبرع</option>
        <option value="busy">مشغول حالياً</option>
        <option value="away">خارج المدينة</option>
        <option value="unavailable">غير متاح</option>
      </select>
    </div>
    
    <button id="btn-save-edit"><i class="fas fa-save"></i> حفظ التعديل</button>
    <button id="btn-delete-donor"><i class="fas fa-trash-alt"></i> حذف المتبرع</button>
    <button id="btn-cancel-edit"><i class="fas fa-times"></i> إلغاء</button>
  </div>
</div>

<div id="search" class="section">
  <h3 style="margin-bottom: 4px;"><i class="fas fa-search"></i> البحث عن متبرعين</h3>
  <p style="font-size: 15px; color: #b71c1c; line-height: 1.2; margin-top: 0; font-weight: 500;">
    <i class="fas fa-info-circle"></i> للباحثين عن نوع فصيلة دم محددة
  </p>
  
  <label class="field-label">
    <i class="fas fa-tint"></i> نوع الفصيلة
  </label>
  <div class="input-icon">
    <i class="fas fa-chevron-down"></i>
    <select id="searchBlood">
      <option value="">ابحث بنوع الفصيلة</option>
      <option>+A</option><option>-A</option>
      <option>+B</option><option>-B</option>
      <option>+AB</option><option>-AB</option>
      <option>+O</option><option>-O</option>
    </select>
  </div>
  
  <div class="input-icon">
    <i class="fas fa-search"></i>
    <input type="text" id="searchQuery" placeholder="بحث بالاسم أو الهاتف أو المنطقة">
  </div>
  
  <div id="donorCount" style="margin:15px 0;font-size:18px;font-weight:bold;color:#333;text-align:center;">
    <i class="fas fa-users"></i> عدد المتبرعين: 0
  </div>
  
  <table>
    <thead>
      <tr>
        <th><i class="fas fa-user"></i> الاسم</th>
        <th><i class="fas fa-phone"></i> الهاتف</th>
        <th><i class="fas fa-tint"></i> الفصيلة</th>
        <th><i class="fas fa-city"></i> المحافظة</th>
        <th><i class="fas fa-map-marker-alt"></i> المديرية</th>
        <th><i class="fas fa-home"></i> السكن</th>
        <th><i class="fab fa-whatsapp"></i> الواتساب</th>
        <th><i class="fas fa-calendar-alt"></i> آخر تبرع</th>
        <th><i class="fas fa-star"></i> التقييم</th>
        <th><i class="fas fa-user-clock"></i> الحالة</th>
        <th><i class="fas fa-edit"></i> تعديل</th>
      </tr>
    </thead>
    <tbody id="donorsTable"></tbody>
  </table>
</div>

<!-- النوافذ المنبثقة -->
<div id="successPopup" class="popup-message">
  <div class="popup-icon success-icon">
    <i class="fas fa-check-circle"></i>
  </div>
  <p id="successMessage"></p>
</div>

<div id="errorPopup" class="popup-message">
  <div class="popup-icon error-icon">
    <i class="fas fa-exclamation-circle"></i>
  </div>
  <p id="errorMessage"></p>
</div>

<div id="passwordPopup" class="popup-message">
  <div class="popup-icon">
    <i class="fas fa-lock"></i>
  </div>
  <h3>التحقق من الهوية</h3>
  <p>للدخول إلى قسم التعديل، يرجى إدخال كلمة المرور</p>
  
  <div class="input-icon">
    <i class="fas fa-key"></i>
    <input type="password" id="passwordInput" placeholder="كلمة المرور">
  </div>
  
  <p id="passwordError"></p>
  
  <button id="btn-check-password"><i class="fas fa-check"></i> دخول</button>
  <button id="btn-close-password-popup"><i class="fas fa-times"></i> إغلاق</button>
  <p style="font-size:12px;color:gray;">
    <i class="fas fa-info-circle"></i> للتعديل أو الحذف، تواصل على الواتس: 00966511479262 نبيل اليافعي
  </p>
</div>

<div id="updateDatePopup" class="update-date-popup">
  <div class="popup-icon">
    <i class="fas fa-calendar-check"></i>
  </div>
  <h3>تحديث تاريخ التبرع</h3>
  
  <div class="input-icon">
    <i class="fas fa-calendar-day"></i>
    <input type="date" id="newDonationDate">
  </div>
  
  <button id="btn-save-donation-date"><i class="fas fa-save"></i> حفظ</button>
  <button id="btn-close-update-date-popup"><i class="fas fa-times"></i> إلغاء</button>
</div>

<div id="emergencyPopup" class="popup-message">
  <div class="popup-icon warning-icon">
    <i class="fas fa-exclamation-triangle"></i>
  </div>
  <h3>إرسال تنبيه طارئ</h3>
  
  <div class="input-icon">
    <i class="fas fa-tint"></i>
    <select id="emergencyBloodType" required>
      <option value="">اختر فصيلة الدم</option>
      <option>+A</option><option>-A</option>
      <option>+B</option><option>-B</option>
      <option>+AB</option><option>-AB</option>
      <option>+O</option><option>-O</option>
    </select>
  </div>
  
  <div class="input-icon">
    <i class="fas fa-map-marker-alt"></i>
    <input type="text" id="emergencyLocation" placeholder="المحافظة والمديرية" required>
  </div>
  
  <textarea id="emergencyMessage" placeholder="أدخل رسالة الطوارئ هنا..." required></textarea>
  
  <div id="emergencyRecipientsCount" style="margin:10px 0;font-weight:bold;color:#b30000;"></div>
  
  <button id="btn-confirm-emergency"><i class="fas fa-paper-plane"></i> إرسال</button>
  <button id="btn-cancel-emergency"><i class="fas fa-times"></i> إلغاء</button>
</div>

<div id="ratingPopup" class="popup-message" style="width: 90%; max-width: 600px;">
  <div class="popup-icon">
    <i class="fas fa-star"></i>
  </div>
  <h3>تقييم المتبرع: <span id="ratedDonorName"></span></h3>
  
  <div class="stars-container" style="margin: 20px 0;">
    <i class="far fa-star" data-rating="1"></i>
    <i class="far fa-star" data-rating="2"></i>
    <i class="far fa-star" data-rating="3"></i>
    <i class="far fa-star" data-rating="4"></i>
    <i class="far fa-star" data-rating="5"></i>
  </div>
  
  <textarea id="ratingComment" placeholder="تعليقك (اختياري)..."></textarea>
  
  <div id="previousRatings" style="margin-top: 20px; max-height: 200px; overflow-y: auto;">
    <h4 style="color: #b30000; border-bottom: 1px solid #eee; padding-bottom: 5px;">التقييمات السابقة</h4>
    <div id="ratingsList"></div>
  </div>
  
  <button id="btn-submit-rating"><i class="fas fa-check"></i> تقديم التقييم</button>
  <button id="btn-cancel-rating"><i class="fas fa-times"></i> إلغاء</button>
</div>

<div id="suggestionsPopup" class="popup-message" style="width: 90%; max-width: 600px;">
  <div class="popup-icon">
    <i class="fas fa-lightbulb"></i>
  </div>
  <h3>اقتراحات تطوير التطبيق</h3>
  
  <p style="text-align: right; color: #666;">
    نرحب بآرائكم واقتراحاتكم لتطوير تطبيق قطرة أمل وتحسين خدماته
  </p>
  
  <div class="input-icon">
    <i class="fas fa-user"></i>
    <input type="text" id="suggestionName" placeholder="اسمك (اختياري)">
  </div>
  
  <div class="input-icon">
    <i class="fas fa-phone"></i>
    <input type="tel" id="suggestionContact" class="phone-input" placeholder="رقم للتواصل (اختياري)" dir="ltr">
  </div>
  
  <textarea id="suggestionText" placeholder="أدخل اقتراحك هنا..." required></textarea>
  
  <button id="btn-submit-suggestion"><i class="fas fa-paper-plane"></i> إرسال الاقتراح</button>
  <button id="btn-cancel-suggestion"><i class="fas fa-times"></i> إلغاء</button>
</div>

<div id="donorSelfEditPopup" class="popup-message">
  <div class="popup-icon">
    <i class="fas fa-user-edit"></i>
  </div>
  <h3>تعديل بياناتي</h3>
  
  <div class="input-icon">
    <i class="fab fa-whatsapp"></i>
    <input type="tel" id="selfEditWhatsapp" class="whatsapp-input" placeholder="رقم الواتساب" dir="ltr">
  </div>
  
  <label class="field-label">
    <i class="fas fa-calendar-alt"></i> تاريخ آخر تبرع
  </label>
  <div class="input-icon">
    <i class="far fa-calendar"></i>
    <input type="date" id="selfEditLastDate">
  </div>
  
  <label class="field-label">
    <i class="fas fa-user-clock"></i> حالة التوفر الحالية
  </label>
  <div class="input-icon">
    <i class="fas fa-chevron-down"></i>
    <select id="selfEditAvailability">
      <option value="available">متاح للتبرع</option>
      <option value="busy">مشغول حالياً</option>
      <option value="away">خارج المدينة</option>
      <option value="unavailable">غير متاح</option>
    </select>
  </div>
  
  <button id="btn-save-self-edit"><i class="fas fa-save"></i> حفظ التعديلات</button>
  <button id="btn-cancel-self-edit"><i class="fas fa-times"></i> إلغاء</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, getDocs, query, where, doc, 
    updateDoc, deleteDoc, runTransaction, getDoc, orderBy, limit 
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
  import { 
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
    signOut, updateProfile, setPersistence, browserLocalPersistence 
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfIBS2gB4lkRZ1_ZerLk451EVfafrfWSM",
    authDomain: "qtratamal.firebaseapp.com",
    projectId: "qtratamal",
    storageBucket: "qtratamal.appspot.com",
    messagingSenderId: "491056452067",
    appId: "1:491056452067:web:0c8ef019a651cd47c290d6",
    databaseURL: "https://qtratamal.firebaseio.com"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // تفعيل تخزين حالة المصادقة محلياً
  setPersistence(auth, browserLocalPersistence)
    .then(() => console.log("تم تفعيل التخزين المحلي لحالة المصادقة"))
    .catch(error => console.error("خطأ في تفعيل التخزين المحلي:", error));

  let currentDonorDocId = null;
  let currentDisplayedDonors = [];
  let isProcessing = false;
  const pendingOperations = new Set();
  let currentUser = null;
  let donorsCache = null;
  let lastFetchTime = null;
  let searchTimeout;

  // وظائف مساعدة
  function showLoading(message = 'جاري المعالجة...') {
    const loader = document.getElementById('loadingIndicator');
    loader.style.display = 'block';
    loader.querySelector('p').textContent = message;
  }

  function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
  }

  function showMessage(msg, type = 'success') {
    const popup = type === 'success' ? document.getElementById('successPopup') : document.getElementById('errorPopup');
    const messageElement = type === 'success' ? document.getElementById('successMessage') : document.getElementById('errorMessage');
    
    messageElement.textContent = msg;
    popup.classList.add('active'); 
    setTimeout(() => popup.classList.remove('active'), 3000);
  }

  function formatDate(dateString) {
    if (!dateString) return '—';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function normalizeArabic(text) {
    return text
      .toLowerCase()
      .trim()
      .replace(/[\u064B-\u065F]/g, '')
      .replace(/[\u0622\u0623\u0625]/g, 'ا')
      .replace(/ة/g, 'ه')
      .replace(/ى/g, 'ي')
      .replace(/\s+/g, ' ');
  }

  function renderRatingStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
      stars += i <= rating 
        ? '<i class="fas fa-star" style="color:gold"></i>'
        : '<i class="far fa-star" style="color:gold"></i>';
    }
    return stars;
  }

  function getAvailabilityText(availability) {
    switch(availability) {
      case 'available': return 'متاح';
      case 'busy': return 'مشغول';
      case 'away': return 'خارج المدينة';
      case 'unavailable': return 'غير متاح';
      default: return 'متاح';
    }
  }

  // نظام تسجيل الدخول
  async function loginUser(phone, password) {
    const loginError = document.getElementById('loginError');
    loginError.style.display = 'none';
    
    if (!phone || !password) {
      loginError.textContent = 'يرجى إدخال رقم الهاتف وكلمة المرور';
      loginError.style.display = 'block';
      return;
    }
    
    try {
      showLoading('جاري التحقق من البيانات...');
      
      // إضافة مهلة زمنية لمنع التجميد
const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error('تجاوز الوقت المحدد للمعالجة')), 10000);
});
      const email = `${phone}@qtratamal.com`;
      const loginPromise = signInWithEmailAndPassword(auth, email, password);
      
      // الانتظار لأي من الوظيفتين (التسجيل أو المهلة)
      const userCredential = await Promise.race([loginPromise, timeoutPromise]);
      
      currentUser = userCredential.user;
      
      // إخفاء مؤشر التحميل فورًا بعد النجاح
      hideLoading();
      
      // عرض واجهة المستخدم
      showSection('welcome');
      updateUserProfile();
      
    } catch (error) {
      console.error(error);
      hideLoading(); // التأكد من إخفاء المؤشر في حالة الخطأ
      
      let errorMessage = 'رقم الهاتف أو كلمة المرور غير صحيحة';
      if (error.message.includes('تجاوز الوقت المحدد')) {
          errorMessage = 'استغرقت العملية وقتًا طويلاً، يرجى المحاولة مرة أخرى';
      } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'مشكلة في الاتصال بالإنترنت، يرجى التحقق من الاتصال';
      }
      
      loginError.textContent = errorMessage;
      loginError.style.display = 'block';
    }
  }

  async function registerUser(name, phone, password, confirmPassword) {
    const registerError = document.getElementById('registerError');
    registerError.style.display = 'none';
    
    if (!name || !phone || !password || !confirmPassword) {
      registerError.textContent = 'يرجى تعبئة جميع الحقول';
      registerError.style.display = 'block';
      return;
    }
    
    if (password.length < 6) {
      registerError.textContent = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
      registerError.style.display = 'block';
      return;
    }
    
    if (password !== confirmPassword) {
      registerError.textContent = 'كلمة المرور غير متطابقة';
      registerError.style.display = 'block';
      return;
    }
    
    const phoneRegex = /^[0-9]{9}$/;
    if (!phoneRegex.test(phone)) {
      registerError.textContent = 'رقم الهاتف يجب أن يتكون من 9 أرقام فقط';
      registerError.style.display = 'block';
      return;
    }
    
    try {
      showLoading('جاري إنشاء الحساب...');
      
      // التحقق من عدم وجود مستخدم بنفس رقم الهاتف
      const email = `${phone}@qtratamal.com`;
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      
      // تحديث اسم المستخدم
      await updateProfile(userCredential.user, {
        displayName: name
      });
      
      currentUser = userCredential.user;
      
      // عرض واجهة المستخدم
      showSection('welcome');
      updateUserProfile();
      showMessage('تم تسجيل حسابك بنجاح');
      
    } catch (error) {
      console.error(error);
      if (error.code === 'auth/email-already-in-use') {
        registerError.textContent = 'رقم الهاتف مسجل بالفعل';
      } else {
        registerError.textContent = 'حدث خطأ أثناء التسجيل';
      }
      registerError.style.display = 'block';
    } finally {
      hideLoading();
    }
  }

  function logoutUser() {
    signOut(auth).then(() => {
      currentUser = null;
      showSection('loginSection');
      document.getElementById('userProfile').style.display = 'none';
      // مسح البيانات المخزنة مؤقتاً
      donorsCache = null;
      lastFetchTime = null;
    }).catch(error => {
      console.error(error);
      showMessage('حدث خطأ أثناء تسجيل الخروج', 'error');
    });
  }

  function updateUserProfile() {
    if (currentUser) {
      document.getElementById('userName').textContent = currentUser.displayName || 'مستخدم';
      document.getElementById('userProfile').style.display = 'flex';
    }
  }

  // وظائف التطبيق الأساسية
  async function addDonor() {
    if (isProcessing) return;
    
    const donorName = document.getElementById('donorName').value.trim();
    const nameParts = donorName.split(/\s+/);
    const donorPhone = document.getElementById('donorPhone').value.trim();
    const btn = document.getElementById('btn-add-donor');
    
    if (pendingOperations.has(donorPhone)) {
      showMessage('جاري معالجة هذا المتبرع، يرجى الانتظار...', 'error');
      return;
    }

    if (nameParts.length < 2 || nameParts.length > 4) {
      showMessage("الاسم يجب أن يتكون من أسمين إلى أربعة أسماء فقط.", 'error');
      return;
    }
    
    const phoneRegex = /^[0-9]{9}$/;
    if (!phoneRegex.test(donorPhone)) {
      showMessage('رقم الهاتف يجب أن يتكون من 9 أرقام فقط', 'error');
      return;
    }
    
    const donorWhatsapp = document.getElementById('donorWhatsapp').value.trim();
    if (donorWhatsapp) {
      const whatsappRegex = /^967\d{9}$/;
      if (!whatsappRegex.test(donorWhatsapp)) {
        showMessage('رقم الواتساب يجب أن يبدأ بـ 967 ويتكون من 12 رقماً مثال: 967712345678', 'error');
        return;
      }
    }

    try {
      isProcessing = true;
      pendingOperations.add(donorPhone);
      btn.disabled = true;
      showLoading('جاري تسجيل المتبرع...');
      
      // التحقق من التكرار على السيرفر
      const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', donorPhone)));
      
      if (!phoneSnap.empty) {
        showMessage('رقم الهاتف مسجل بالفعل', 'error');
        return;
      }
      
      const d = {
        name: donorName,
        phone: donorPhone,
        city: document.getElementById('donorCity').value.trim(),
        area: document.getElementById('donorArea').value.trim(),
        location: document.getElementById('donorLocation').value.trim(),
        lastDate: document.getElementById('donorLastDate').value || null,
        whatsapp: donorWhatsapp || null,
        blood: document.getElementById('donorBlood').value,
        notifications: document.getElementById('donorNotification').value === 'enabled',
        availability: document.getElementById('donorAvailability').value,
        createdAt: new Date().toISOString(),
        createdBy: currentUser ? currentUser.uid : null
      };
      
      if (!d.name || !d.phone || !d.city || !d.area || !d.blood) { 
        showMessage('يرجى تعبئة جميع الحقول الأساسية', 'error'); 
        return; 
      }

      await addDoc(collection(db, 'donors'), d);
      showMessage('تم تسجيل بياناتك بنجاح جزاك الله خير');
      document.querySelectorAll('#register input').forEach(i => i.value = '');
      document.getElementById('donorBlood').selectedIndex = 0;
      
      // تحديث البيانات المخزنة مؤقتاً
      donorsCache = null;
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء التسجيل', 'error');
    } finally {
      isProcessing = false;
      pendingOperations.delete(donorPhone);
      btn.disabled = false;
      hideLoading();
    }
  }

  async function searchDonorToEdit() {
    if (isProcessing) return;
    
    const input = document.getElementById('editSearchInput').value.trim();
    const btn = document.getElementById('btn-search-donor-edit');
    
    if (!input) { 
      showMessage('الرجاء إدخال الاسم أو رقم الهاتف', 'error'); 
      return; 
    }
    
    try {
      isProcessing = true;
      btn.disabled = true;
      showLoading('جاري البحث عن المتبرع...');
      
      const donors = await getDonors();
      const normInput = normalizeArabic(input);
      const found = donors.find(d => {
        const normName = normalizeArabic(d.name || '');
        const normPhone = normalizeArabic(d.phone || '');
        return normName === normInput || normPhone === normInput;
      });
      
      if (found) {
        currentDonorDocId = found.id;
        document.getElementById('editingDonorId').textContent = found.id;
        document.getElementById('editSection').style.display = 'block';
        document.getElementById('editNewName').value = found.name;
        document.getElementById('editPhone').value = found.phone;
        document.getElementById('editWhatsapp').value = found.whatsapp || '';
        document.getElementById('editCity').value = found.city;
        document.getElementById('editArea').value = found.area;
        document.getElementById('editLocation').value = found.location || '';
        document.getElementById('editLastDate').value = found.lastDate || '';
        document.getElementById('editBlood').value = found.blood;
        document.getElementById('editNotification').value = found.notifications ? 'enabled' : 'disabled';
        document.getElementById('editAvailability').value = found.availability || 'available';
      } else {
        showMessage('المتبرع غير موجود', 'error');
      }
    } catch (e) { 
      console.error(e); 
      showMessage('خطأ أثناء البحث', 'error'); 
    } finally {
      isProcessing = false;
      btn.disabled = false;
      hideLoading();
    }
  }

  async function saveEdit() {
    if (isProcessing || !currentDonorDocId) return;
    
    const btn = document.getElementById('btn-save-edit');
    const updated = {
      name: document.getElementById('editNewName').value.trim(),
      phone: document.getElementById('editPhone').value.trim(),
      city: document.getElementById('editCity').value.trim(),
      area: document.getElementById('editArea').value.trim(),
      location: document.getElementById('editLocation').value.trim(),
      lastDate: document.getElementById('editLastDate').value || null,
      whatsapp: document.getElementById('editWhatsapp').value.trim() || null,
      blood: document.getElementById('editBlood').value,
      notifications: document.getElementById('editNotification').value === 'enabled',
      availability: document.getElementById('editAvailability').value,
      updatedAt: new Date().toISOString(),
      updatedBy: currentUser ? currentUser.uid : null
    };
    
    try {
      isProcessing = true;
      btn.disabled = true;
      showLoading('جاري حفظ التعديلات...');
      
      if (updated.whatsapp) {
        const whatsappRegex = /^967\d{9}$/;
        if (!whatsappRegex.test(updated.whatsapp)) {
          showMessage('رقم الواتساب يجب أن يبدأ بـ 967 ويتكون من 12 رقماً مثال: 967712345678', 'error');
          return;
        }
      }
      
      // التحقق من التكرار في الأسماء
      const nameSnap = await getDocs(query(collection(db, 'donors'), where('name', '==', updated.name)));
      if (!nameSnap.empty && nameSnap.docs.some(doc => doc.id !== currentDonorDocId)) { 
        showMessage('هذا الاسم مسجل لمتبرع آخر', 'error'); 
        return; 
      }
      
      // التحقق من التكرار في أرقام الهاتف
      const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', updated.phone)));
      if (!phoneSnap.empty && phoneSnap.docs.some(doc => doc.id !== currentDonorDocId)) { 
        showMessage('رقم الهاتف مسجل لمتبرع آخر', 'error'); 
        return; 
      }
      
      await updateDoc(doc(db, 'donors', currentDonorDocId), updated);
      showMessage('تم التعديل بنجاح');
      document.getElementById('editSection').style.display = 'none'; 
      currentDonorDocId = null;
      
      // تحديث البيانات المخزنة مؤقتاً
      donorsCache = null;
    } catch (e) { 
      console.error(e); 
      showMessage('خطأ أثناء الحفظ', 'error'); 
    } finally {
      isProcessing = false;
      btn.disabled = false;
      hideLoading();
    }
  }

  async function deleteDonor() { 
    if (isProcessing || !currentDonorDocId) return;
    if (!confirm('هل أنت متأكد من حذف هذا المتبرع؟')) return;
    
    const btn = document.getElementById('btn-delete-donor');
    
    try {
      isProcessing = true;
      btn.disabled = true;
      showLoading('جاري حذف المتبرع...');
      
      await deleteDoc(doc(db, 'donors', currentDonorDocId)); 
      showMessage('تم حذف المتبرع بنجاح');
      document.getElementById('editSection').style.display = 'none'; 
      currentDonorDocId = null;
      
      // تحديث البيانات المخزنة مؤقتاً
      donorsCache = null;
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء الحذف', 'error');
    } finally {
      isProcessing = false;
      btn.disabled = false;
      hideLoading();
    }
  }

  function cancelEdit() { 
    document.getElementById('editSection').style.display = 'none'; 
    currentDonorDocId = null; 
  }

  async function getDonors() {
    const now = new Date().getTime();
    
    // إذا كانت البيانات مخزنة مؤقتاً ولم يمض أكثر من 5 دقائق
    if (donorsCache && lastFetchTime && (now - lastFetchTime < 300000)) {
      return donorsCache;
    }
    
    const snap = await getDocs(collection(db, 'donors'));
    donorsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    lastFetchTime = now;
    
    return donorsCache;
  }

  function renderSearchTable(donors) {
    const tbody = document.getElementById('donorsTable'); 
    tbody.innerHTML = '';
    
    if (!donors.length) { 
      tbody.innerHTML = '<tr><td colspan="11">لا يوجد متبرعون</td></tr>'; 
      document.getElementById('donorCount').innerHTML = '<i class="fas fa-users"></i> عدد المتبرعين: 0'; 
      currentDisplayedDonors = []; 
      return; 
    }
    
    currentDisplayedDonors = donors; 
    document.getElementById('donorCount').innerHTML = `<i class="fas fa-users"></i> عدد المتبرعين: ${donors.length}`;
    
    const availabilityClasses = {
      available: 'available',
      busy: 'busy',
      away: 'away',
      unavailable: 'unavailable'
    };
    
    donors.forEach(d => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td data-label="الاسم">${d.name}</td>
        <td data-label="الهاتف">
          <div style="display:flex;flex-direction:column;align-items:center;gap:5px;">
            <a href="tel:${d.phone}" style="color:white;background-color:#1b5e20;padding:5px 10px;border-radius:8px;display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-weight:bold;font-size:12px;white-space:nowrap;">
              <i class="fas fa-phone"></i>
              اضغط للإتصال
            </a>
           <span style="color:#b30000;font-weight:bold;direction:ltr;text-align:right;font-family:monospace;font-size:18px;">${d.phone}</span>
          </div>
        </td> 
        <td data-label="الفصيلة">${d.blood}</td>
        <td data-label="المحافظة">${d.city}</td>
        <td data-label="المديرية">${d.area}</td>
        <td data-label="السكن">${d.location || '—'}</td>
        <td data-label="الواتساب">
          ${
            d.whatsapp
              ? `<a href="https://wa.me/${d.whatsapp}" target="_blank"
                    style="color:green; text-decoration:none; font-weight:bold;
                           display:flex; flex-direction:column; align-items:center;
                           font-size: 0.95em;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <i class="fab fa-whatsapp" style="font-size:1.2em;"></i>
                      <span>${d.whatsapp}</span>
                    </div>
                    <small style="color:#006400; font-weight:normal; margin-top:5px; font-size:13px;">
                      اضغط للتواصل واتساب مباشرة
                    </small>
                 </a>`
              : "—"
          }
        </td>
        <td data-label="آخر تبرع">${d.lastDate ? formatDate(d.lastDate) : '—'}</td>
        <td data-label="التقييم">
          <div class="donor-rating" data-donor-id="${d.id}" data-donor-name="${d.name}">
            ${renderRatingStars(d.rating || 0)}
            <small>(${d.ratingCount || 0} تقييم)</small>
          </div>
        </td>
        <td data-label="الحالة">
          <span class="availability-badge ${availabilityClasses[d.availability] || 'available'}">
            ${getAvailabilityText(d.availability)}
          </span>
        </td>
        <td data-label="تعديل">
          <button data-donor-id="${d.id}" class="btn-self-edit" style="background-color:#1565c0;margin-bottom:5px;">
            <i class="fas fa-user-edit"></i> تعديل بياناتي
          </button>
          <button data-donor-id="${d.id}" class="btn-update-date">
            <i class="fas fa-edit"></i> تحديث آخر تبرع
          </button>
        </td>
      `;
    });
    
    document.querySelectorAll('.btn-update-date').forEach(btn => {
      btn.addEventListener('click', () => enableEditDate(btn.getAttribute('data-donor-id')));
    });
    
    document.querySelectorAll('.btn-self-edit').forEach(btn => {
      btn.addEventListener('click', () => showDonorSelfEditPopup(btn.getAttribute('data-donor-id')));
    });
    
    document.querySelectorAll('.donor-rating').forEach(rating => {
      rating.addEventListener('click', () => showRatingPopup(
        rating.getAttribute('data-donor-id'),
        rating.getAttribute('data-donor-name')
      ));
    });
  }

  async function searchDonors() {
    if (isProcessing) return;
    
    const blood = document.getElementById('searchBlood').value;
    const text = normalizeArabic(document.getElementById('searchQuery').value);
    
    try {
      isProcessing = true;
      showLoading('جاري البحث عن المتبرعين...');
      
      const donors = await getDonors();
      let filteredDonors = donors;
      
      if (blood) {
        filteredDonors = filteredDonors.filter(d => d.blood === blood);
      }
      
      if (text) {
        filteredDonors = filteredDonors.filter(d => {
          const fields = [d.name, d.phone, d.city, d.area, d.location].map(f => normalizeArabic(f || ''));
          return fields.some(f => f.includes(text));
        });
      }
      
      renderSearchTable(filteredDonors);
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء البحث', 'error');
    } finally {
      isProcessing = false;
      hideLoading();
    }
  }

  function enableEditDate(id) { 
    currentDonorDocId = id; 
    document.getElementById('updateDatePopup').classList.add('active'); 
    document.getElementById('newDonationDate').value = ''; 
  }

  async function saveDonationDate() {
    if (isProcessing) return;
    
    const newDate = document.getElementById('newDonationDate').value;
    const btn = document.getElementById('btn-save-donation-date');
    
    if (!newDate) { 
      showMessage('يرجى إدخال تاريخ التبرع', 'error'); 
      return; 
    }
    
    try { 
      isProcessing = true;
      btn.disabled = true;
      showLoading('جاري تحديث التاريخ...');
      
      await updateDoc(doc(db, 'donors', currentDonorDocId), { 
        lastDate: newDate,
        updatedAt: new Date().toISOString(),
        updatedBy: currentUser ? currentUser.uid : null
      }); 
      
      showMessage('تم تحديث تاريخ التبرع بنجاح');
      
      // تحديث الجدول مباشرة دون الحاجة لإعادة جلب البيانات
      const donorIndex = currentDisplayedDonors.findIndex(d => d.id === currentDonorDocId);
      if (donorIndex !== -1) {
          currentDisplayedDonors[donorIndex].lastDate = newDate;
          renderSearchTable(currentDisplayedDonors);
      }
      
      closeUpdateDatePopup(); 
      currentDonorDocId = null; 
      
      // تحديث البيانات المخزنة مؤقتاً
      donorsCache = null;
    } catch(e) { 
      console.error('Error updating donation date:', e); 
      showMessage('حدث خطأ أثناء التحديث', 'error'); 
    } finally {
      isProcessing = false;
      btn.disabled = false;
      hideLoading();
    }
  }

  function closeUpdateDatePopup() { 
    document.getElementById('updateDatePopup').classList.remove('active'); 
    currentDonorDocId = null; 
  }

  async function sendEmergencyAlert() {
    const message = document.getElementById('emergencyMessage').value.trim();
    const bloodType = document.getElementById('emergencyBloodType').value;
    const location = document.getElementById('emergencyLocation').value.trim();
    
    if (!message || !bloodType || !location) {
      showMessage('يرجى تعبئة جميع الحقول المطلوبة', 'error');
      return;
    }

    try {
      showLoading('جاري إعداد التنبيه...');
      
      // تقسيم الموقع إلى محافظة ومديرية
      const [city, area] = location.split(/\s*\/\s*/);
      
      // البحث عن المتبرعين المناسبين
      const q = query(
        collection(db, 'donors'),
        where('blood', '==', bloodType),
        where('city', '==', city),
        where('area', '==', area),
        where('notifications', '==', true),
        where('availability', 'in', ['available', 'busy'])
      );
      
      const snap = await getDocs(q);
      const donors = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      if (donors.length === 0) {
        showMessage('لا يوجد متبرعون متاحون في هذا الموقع', 'error');
        return;
      }
      
      // عرض النتائج مباشرة في النافذة المنبثقة
      const recipientsList = donors.map(d => 
          `<div style="padding: 5px; border-bottom: 1px solid #eee;">
              ${d.name} - ${d.phone} - ${d.blood}
          </div>`
      ).join('');
      
      document.getElementById('emergencyRecipientsCount').innerHTML = `
          <div style="margin: 10px 0; font-weight: bold; color: #b30000;">
              سيتم إرسال التنبيه إلى ${donors.length} متبرع:
          </div>
          <div style="max-height: 200px; overflow-y: auto; margin: 10px 0;">
              ${recipientsList}
          </div>
          <div style="margin-top: 10px;">
              <strong>رسالة التنبيه:</strong>
              <div style="padding: 10px; background: #f5f5f5; border-radius: 5px; margin-top: 5px;">
                  ${message}
              </div>
          </div>
      `;
      
      // إضافة زر تأكيد الإرسال النهائي
      const confirmBtn = document.getElementById('btn-confirm-emergency');
      confirmBtn.textContent = `تأكيد الإرسال إلى ${donors.length} متبرع`;
      confirmBtn.onclick = async () => {
          try {
              showLoading('جاري إرسال التنبيه...');
              await addDoc(collection(db, 'notifications'), {
                  message,
                  bloodType,
                  city,
                  area,
                  timestamp: new Date().toISOString(),
                  status: 'sent',
                  recipients: donors.map(d => d.id),
                  sender: currentUser ? currentUser.uid : 'anonymous'
              });
              
              showMessage(`تم إرسال التنبيه إلى ${donors.length} متبرع`);
              document.getElementById('emergencyPopup').classList.remove('active');
          } catch (e) {
              console.error(e);
              showMessage('حدث خطأ أثناء إرسال التنبيه', 'error');
          } finally {
              hideLoading();
          }
      };
      
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء البحث عن المتبرعين', 'error');
      hideLoading();
    }
  }

  async function showRatingPopup(donorId, donorName) {
    currentDonorDocId = donorId;
    
    try {
      showLoading('جاري تحميل التقييمات...');
      
      document.getElementById('ratedDonorName').textContent = donorName;
      
      // جلب التقييمات السابقة
      const ratingsQuery = query(
        collection(db, 'ratings'),
        where('donorId', '==', donorId),
        orderBy('timestamp', 'desc'),
        limit(10)
      );
      
      const ratingsSnap = await getDocs(ratingsQuery);
      const ratings = ratingsSnap.docs.map(d => d.data());
      
      const ratingsList = document.getElementById('ratingsList');
      ratingsList.innerHTML = ratings.length > 0 
        ? ratings.map(r => `
            <div style="padding: 10px; border-bottom: 1px solid #eee;">
              <div style="display: flex; justify-content: space-between;">
                <div>${renderRatingStars(r.rating)}</div>
                <small style="color: #666;">${formatDate(r.timestamp)}</small>
              </div>
              ${r.comment ? `<p style="margin: 5px 0; color: #333;">${r.comment}</p>` : ''}
            </div>
          `).join('')
        : '<p style="text-align: center; color: #666;">لا توجد تقييمات سابقة</p>';
      
      document.getElementById('ratingPopup').classList.add('active');
      document.getElementById('ratingComment').value = '';
      
      // إعادة تعيين النجوم
      document.querySelectorAll('#ratingPopup .stars-container i').forEach(s => {
        s.className = 'far fa-star';
        s.style.color = 'gold';
      });
      
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء تحميل بيانات التقييم', 'error');
    } finally {
      hideLoading();
    }
  }

  async function submitRating() {
    const rating = parseInt(document.querySelector('#ratingPopup .stars-container .fas')?.getAttribute('data-rating') || 0);
    const comment = document.getElementById('ratingComment').value.trim();
    
    if (!rating || rating < 1 || rating > 5) {
      showMessage('يرجى اختيار تقييم من 1 إلى 5 نجوم', 'error');
      return;
    }

    try {
      showLoading('جاري تسجيل التقييم...');
      
      // استخدام المعاملة لضمان التحديث الآمن
      await runTransaction(db, async (transaction) => {
        const donorRef = doc(db, 'donors', currentDonorDocId);
        const donorDoc = await transaction.get(donorRef);
        
        if (!donorDoc.exists()) {
          throw "المتبرع غير موجود";
        }
        
        const currentData = donorDoc.data();
        const currentRating = currentData.rating || 0;
        const currentCount = currentData.ratingCount || 0;
        
        // حساب التقييم الجديد
        const newCount = currentCount + 1;
        const newRating = ((currentRating * currentCount) + rating) / newCount;
        
        transaction.update(donorRef, {
          rating: newRating,
          ratingCount: newCount
        });
        
        // حفظ التقييم كسجل منفصل
        await addDoc(collection(db, 'ratings'), {
          donorId: currentDonorDocId,
          rating,
          comment,
          timestamp: new Date().toISOString(),
          ratedBy: currentUser ? currentUser.uid : 'anonymous'
        });
      });
      
      showMessage('شكراً لتقييمك المتبرع!');
      document.getElementById('ratingPopup').classList.remove('active');
      
      // تحديث الجدول
      const donorIndex = currentDisplayedDonors.findIndex(d => d.id === currentDonorDocId);
      if (donorIndex !== -1) {
        const donor = currentDisplayedDonors[donorIndex];
        donor.rating = ((donor.rating || 0) * (donor.ratingCount || 0) + rating) / ((donor.ratingCount || 0) + 1);
        donor.ratingCount = (donor.ratingCount || 0) + 1;
        renderSearchTable(currentDisplayedDonors);
      }
      
      // تحديث البيانات المخزنة مؤقتاً
      donorsCache = null;
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء تسجيل التقييم', 'error');
    } finally {
      hideLoading();
    }
  }

  async function showDonorSelfEditPopup(donorId) {
    currentDonorDocId = donorId;
    
    try {
      showLoading('جاري تحميل البيانات...');
      
      const docSnap = await getDoc(doc(db, 'donors', donorId));
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('selfEditWhatsapp').value = data.whatsapp || '';
        document.getElementById('selfEditLastDate').value = data.lastDate || '';
        document.getElementById('selfEditAvailability').value = data.availability || 'available';
        document.getElementById('donorSelfEditPopup').classList.add('active');
      } else {
        showMessage('المتبرع غير موجود', 'error');
      }
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء تحميل البيانات', 'error');
    } finally {
      hideLoading();
    }
  }

  async function saveDonorSelfEdit() {
    const whatsapp = document.getElementById('selfEditWhatsapp').value.trim();
    const lastDate = document.getElementById('selfEditLastDate').value;
    const availability = document.getElementById('selfEditAvailability').value;
    
    if (whatsapp && !/^967\d{9}$/.test(whatsapp)) {
      showMessage('رقم الواتساب يجب أن يبدأ بـ 967 ويتكون من 12 رقماً', 'error');
      return;
    }

    try {
      showLoading('جاري حفظ التعديلات...');
      
      await updateDoc(doc(db, 'donors', currentDonorDocId), {
        whatsapp: whatsapp || null,
        lastDate: lastDate || null,
        availability,
        updatedAt: new Date().toISOString(),
        updatedBy: currentUser ? currentUser.uid : null
      });
      
      showMessage('تم تحديث بياناتك بنجاح');
      document.getElementById('donorSelfEditPopup').classList.remove('active');
      
      // تحديث الجدول
      const donorIndex = currentDisplayedDonors.findIndex(d => d.id === currentDonorDocId);
      if (donorIndex !== -1) {
        const donor = currentDisplayedDonors[donorIndex];
        donor.whatsapp = whatsapp || null;
        donor.lastDate = lastDate || null;
        donor.availability = availability;
        renderSearchTable(currentDisplayedDonors);
      }
      
      // تحديث البيانات المخزنة مؤقتاً
      donorsCache = null;
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء حفظ التعديلات', 'error');
    } finally {
      hideLoading();
    }
  }

  function closeDonorSelfEditPopup() {
    document.getElementById('donorSelfEditPopup').classList.remove('active');
    currentDonorDocId = null;
  }

  function showSuggestionsPopup() {
    document.getElementById('suggestionsPopup').classList.add('active');
    document.getElementById('suggestionText').value = '';
    document.getElementById('suggestionName').value = '';
    document.getElementById('suggestionContact').value = '';
  }

  function closeSuggestionsPopup() {
    document.getElementById('suggestionsPopup').classList.remove('active');
  }

  async function submitSuggestion() {
    const suggestion = document.getElementById('suggestionText').value.trim();
    const name = document.getElementById('suggestionName').value.trim();
    const contact = document.getElementById('suggestionContact').value.trim();
    
    if (!suggestion) {
      showMessage('يرجى إدخال نص الاقتراح', 'error');
      return;
    }

    try {
      showLoading('جاري إرسال الاقتراح...');
      
      await addDoc(collection(db, 'suggestions'), {
        suggestion,
        name: name || (currentUser ? currentUser.displayName : 'مجهول'),
        contact: contact || null,
        timestamp: new Date().toISOString(),
        status: 'new',
        submittedBy: currentUser ? currentUser.uid : 'anonymous'
      });
      
      showMessage('شكراً لاقتراحك، سيتم دراسته من قبل الفريق');
      closeSuggestionsPopup();
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء إرسال الاقتراح', 'error');
    } finally {
      hideLoading();
    }
  }

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // إظهار/إخفاء عناصر التصفح حسب القسم النشط
    const nav = document.querySelector('nav');
    const header = document.querySelector('header');
    const infoP = document.querySelector('header + p');
    
    if (id === 'welcome') {
      nav.style.display = 'none';
      header.style.display = 'none';
      infoP.style.display = 'none';
    } else if (id === 'loginSection' || id === 'registerSection') {
      nav.style.display = 'none';
      header.style.display = 'none';
      infoP.style.display = 'none';
    } else {
      nav.style.display = 'flex';
      header.style.display = 'block';
      infoP.style.display = 'block';
      
      if (id === 'search') searchDonors();
      if (id === 'register') {
        document.querySelectorAll('#register input').forEach(i => i.value = '');
        document.getElementById('donorBlood').selectedIndex = 0;
      }
      if (id === 'edit') {
        document.getElementById('editSection').style.display = 'none';
        document.getElementById('editSearchInput').value = '';
        currentDonorDocId = null;
        document.getElementById('editingDonorId').textContent = '';
      }
    }
  }

  function setupSearch() {
    const searchInput = document.getElementById('searchQuery');
    
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchDonors();
      }, 500);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    // مستمعي أحداث تسجيل الدخول
    document.getElementById('btn-login-submit').addEventListener('click', () => {
      const phone = document.getElementById('loginPhone').value.trim();
      const password = document.getElementById('loginPassword').value;
      loginUser(phone, password);
    });
    
    document.getElementById('btn-go-to-register').addEventListener('click', () => {
      showSection('registerSection');
    });
    
    document.getElementById('btn-reset-password').addEventListener('click', () => {
      showMessage('لإعادة تعيين كلمة المرور، يرجى التواصل مع المسؤول', 'error');
    });
    
    // مستمعي أحداث التسجيل
    document.getElementById('btn-register-submit').addEventListener('click', () => {
      const name = document.getElementById('registerName').value.trim();
      const phone = document.getElementById('registerPhone').value.trim();
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;
      registerUser(name, phone, password, confirmPassword);
    });
    
    document.getElementById('btn-go-to-login').addEventListener('click', () => {
      showSection('loginSection');
    });
    
    // مستمعي أحداث التطبيق الرئيسية
    document.getElementById('btn-show-register').addEventListener('click', () => showSection('register'));
    document.getElementById('btn-show-search').addEventListener('click', () => showSection('search'));
    document.getElementById('btn-send-emergency').addEventListener('click', () => {
      document.getElementById('emergencyPopup').classList.add('active');
    });
    document.getElementById('btn-show-suggestions').addEventListener('click', showSuggestionsPopup);
    document.getElementById('btn-add-donor').addEventListener('click', addDonor);
    document.getElementById('btn-search-donor-edit').addEventListener('click', searchDonorToEdit);
    document.getElementById('btn-save-edit').addEventListener('click', saveEdit);
    document.getElementById('btn-delete-donor').addEventListener('click', deleteDonor);
    document.getElementById('btn-cancel-edit').addEventListener('click', cancelEdit);
    document.getElementById('searchBlood').addEventListener('change', searchDonors);
    document.getElementById('btn-save-donation-date').addEventListener('click', saveDonationDate);
    document.getElementById('btn-close-update-date-popup').addEventListener('click', closeUpdateDatePopup);
    document.getElementById('btn-confirm-emergency').addEventListener('click', sendEmergencyAlert);
    document.getElementById('btn-cancel-emergency').addEventListener('click', () => {
      document.getElementById('emergencyPopup').classList.remove('active');
    });
    document.getElementById('btn-submit-rating').addEventListener('click', submitRating);
    document.getElementById('btn-cancel-rating').addEventListener('click', () => {
      document.getElementById('ratingPopup').classList.remove('active');
    });
    document.getElementById('btn-start-app').addEventListener('click', () => {
      if (currentUser) {
        showSection('register');
      } else {
        showSection('loginSection');
      }
    });
    document.getElementById('btn-save-self-edit').addEventListener('click', saveDonorSelfEdit);
    document.getElementById('btn-cancel-self-edit').addEventListener('click', closeDonorSelfEditPopup);
    document.getElementById('btn-submit-suggestion').addEventListener('click', submitSuggestion);
    document.getElementById('btn-cancel-suggestion').addEventListener('click', closeSuggestionsPopup);
    document.getElementById('btn-logout').addEventListener('click', logoutUser);
    
    // تفاعل النجوم في نافذة التقييم
    document.querySelectorAll('#ratingPopup .stars-container i').forEach(star => {
      star.addEventListener('mouseover', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        const stars = this.parentElement.querySelectorAll('i');
        stars.forEach((s, idx) => {
          s.className = idx < rating ? 'fas fa-star' : 'far fa-star';
          s.style.color = 'gold';
        });
      });
    });
    
    // إعداد البحث مع تأخير
    setupSearch();
    
    // إدارة حالة المستخدم عند تحميل الصفحة
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        showSection('welcome');
        updateUserProfile();
      } else {
        showSection('loginSection');
      }
    });
    
    // إظهار قسم تسجيل الدخول عند تحميل الصفحة
    showSection('loginSection');
  });
</script>
</body>
</html>

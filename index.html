<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تطبيق قطرة أمل</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* التنسيقات العامة */
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }
    
    body { 
      background: #f9f9f9;
      color: #333;
      line-height: 1.6;
    }
    
    /* التنسيقات المشتركة */
    .btn {
      background-color: #b30000;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .btn:hover {
      background-color: #8c0000;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-secondary {
      background-color: #2e7d32;
    }
    
    .btn-secondary:hover {
      background-color: #1b5e20;
    }
    
    .btn-danger {
      background-color: #d32f2f;
    }
    
    .btn-danger:hover {
      background-color: #b71c1c;
    }
    
    .btn-outline {
      background-color: transparent;
      border: 2px solid #b30000;
      color: #b30000;
    }
    
    .btn-outline:hover {
      background-color: #b30000;
      color: white;
    }
    
    .btn-small {
      padding: 5px 10px;
      font-size: 14px;
    }
    
    .btn-update-date {
      background-color: #2e7d32;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-update-date:hover {
      background-color: #1b5e20;
      transform: translateY(-1px);
    }
    
    /* الهيدر والتنقل */
    header { 
      background-color: #b30000;
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
    }
    
    nav { 
      display: none;
      flex-wrap: wrap;
      justify-content: center;
      background-color: #ffebee;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* الأقسام الرئيسية */
    .section { 
      display: none;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .active { 
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* حقول الإدخال */
    .input-group {
      margin-bottom: 15px;
    }
    
    .field-label {
      color: #b30000;
      font-size: 14px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
      transition: border 0.3s;
      background-color: #fff;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #b30000;
      outline: none;
      box-shadow: 0 0 0 3px rgba(179, 0, 0, 0.1);
    }
    
    .input-icon {
      position: relative;
    }
    
    .input-icon i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #b30000;
      font-size: 18px;
    }
    
    .input-icon input, .input-icon select {
      padding-right: 45px !important;
    }
    
    /* محاذاة أرقام الهاتف والواتساب لليمين */
    .phone-input, .whatsapp-input {
      direction: ltr;
      text-align: right;
      font-family: monospace;
    }
    
    /* الجداول */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    
    thead {
      background-color: #b30000;
      color: white;
    }
    
    tbody tr {
      transition: background 0.3s;
    }
    
    tbody tr:hover {
      background-color: #ffebee;
    }
    
    /* مؤشر التحميل */
    #loadingIndicator {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 25px 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    #loadingIndicator i {
      font-size: 40px;
      color: #b30000;
      margin-bottom: 10px;
    }
    
    #loadingIndicator p {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    /* النوافذ المنبثقة */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }
    
    .popup-message, .update-date-popup { 
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 90%;
      width: 400px;
      animation: popIn 0.3s ease;
    }
    
    @keyframes popIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .popup-message.active, .update-date-popup.active { 
      display: block;
    }
    
    .popup-icon {
      font-size: 50px;
      margin-bottom: 15px;
    }
    
    .success-icon { 
      color: #2e7d32;
    }
    
    .error-icon { 
      color: #b30000;
    }
    
    .popup-message h3 {
      color: #b30000;
      margin-bottom: 15px;
      font-size: 22px;
    }
    
    .popup-message p {
      margin-bottom: 20px;
      font-size: 16px;
    }
    
    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    /* رسائل الخطأ */
    .error-message {
      color: #b30000;
      font-size: 14px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
      display: none;
      padding: 10px;
      background: #ffebee;
      border-radius: 5px;
    }
    
    /* قسم الترحيب */
    #welcome {
      text-align: center;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    #welcome h1 {
      color: #b30000;
      margin-bottom: 30px;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    #welcome .welcome-content {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      margin-bottom: 30px;
      text-align: right;
    }
    
    #welcome h2 {
      color: #b30000;
      font-size: 24px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ffebee;
    }
    
    #welcome h3 {
      color: #b30000;
      margin: 25px 0 15px;
      font-size: 20px;
    }
    
    #welcome p {
      font-size: 18px;
      line-height: 1.7;
      margin-bottom: 15px;
      text-align: justify;
    }
    
    #welcome ul {
      text-align: right;
      font-size: 17px;
      line-height: 1.8;
      list-style-type: none;
      padding: 0;
      margin: 20px 0;
    }
    
    #welcome li {
      margin-bottom: 12px;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      background: #fff9f9;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    #welcome li:hover {
      background: #ffebee;
      transform: translateX(-5px);
    }
    
    #welcome li i {
      color: #b30000;
      font-size: 20px;
      min-width: 25px;
    }
    
    #welcome .quote-box {
      margin: 30px 0;
      padding: 20px;
      background: #ffebee;
      border-radius: 8px;
      border-right: 4px solid #b30000;
      text-align: center;
    }
    
    #welcome .quote-box i {
      color: #b30000;
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    #welcome .quote-box p {
      font-style: italic;
      font-size: 18px;
      margin: 0;
      text-align: center;
    }
    
    #btn-start-app {
      background-color: #b30000;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px 35px;
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 15px;
      margin: 30px auto;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(179, 0, 0, 0.2);
    }
    
    #btn-start-app:hover {
      background-color: #8c0000;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(179, 0, 0, 0.3);
    }
    
    .whatsapp-link {
      display: inline-flex;
      align-items: center;
      padding: 12px 20px;
      background-color: #25D366;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s;
      margin: 10px 0;
      box-shadow: 0 4px 8px rgba(37, 211, 102, 0.2);
    }
    
    .whatsapp-link:hover {
      background-color: #1ebe5d;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(37, 211, 102, 0.3);
    }
    
    .whatsapp-link i {
      margin-right: 10px;
      font-size: 1.3em;
    }
    
    /* الخرائط */
    .map-container {
      margin: 20px 0;
      border: 2px solid #b30000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    #donorsMap, #locationPickerMap, #editLocationPickerMap {
      height: 300px;
      width: 100%;
    }
    
    #donorsMap {
      display: none;
    }
    
    .map-actions {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    /* نافذة طلب إذن الموقع */
    #locationPermission {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 2000;
      text-align: center;
      max-width: 90%;
      width: 350px;
      animation: popIn 0.3s ease;
    }
    
    #locationPermission h3 {
      color: #b30000;
      margin-top: 0;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #locationPermission p {
      margin-bottom: 15px;
      text-align: center;
    }
    
    .permission-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    /* نافذة الإشعارات */
    #notificationsPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 2000;
      text-align: center;
      max-width: 90%;
      width: 400px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    #notificationsPopup h3 {
      color: #b30000;
      margin-top: 0;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #notificationsList {
      flex: 1;
      overflow-y: auto;
      margin: 15px 0;
      text-align: right;
      padding: 5px;
    }
    
    .notification-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      text-align: right;
      margin-bottom: 10px;
      background: #fff9f9;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .notification-item:hover {
      background: #ffebee;
    }
    
    .notification-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .notification-item p {
      margin-bottom: 5px;
    }
    
    .notification-item strong {
      color: #b30000;
    }
    
    .notification-time {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
      justify-content: flex-end;
    }
    
    /* نافذة الطوارئ */
    #emergencyPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 2000;
      text-align: right;
      max-width: 90%;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    #emergencyPopup h3 {
      color: #b30000;
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #emergencyPopup label {
      display: block;
      margin: 15px 0 8px;
      font-weight: bold;
      color: #b30000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    #emergencyPopup textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      min-height: 100px;
      resize: vertical;
    }
    
    #emergencyPopup .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    /* التكيف مع الشاشات الصغيرة */
    @media (max-width: 768px) {
      .section {
        padding: 15px;
      }
      
      #welcome h1 {
        font-size: 24px;
      }
      
      #welcome h2 {
        font-size: 20px;
      }
      
      #welcome h3 {
        font-size: 18px;
      }
      
      #welcome p, #welcome li {
        font-size: 16px;
      }
      
      #btn-start-app {
        font-size: 16px;
        padding: 12px 25px;
      }
      
      nav {
        flex-direction: column;
      }
      
      nav button {
        width: 100%;
        margin: 5px 0;
      }
      
      table, thead, tbody, th, td, tr { 
        display: block; 
      }
      
      thead { 
        display: none; 
      }
      
      tr { 
        margin-bottom: 15px;
        border: 2px solid #b30000;
        padding: 10px;
        border-radius: 8px;
        background-color: #fff;
      }
      
      td { 
        text-align: right;
        padding-right: 50%;
        position: relative;
        border: none;
        border-bottom: 1px solid #eee;
      }
      
      td::before { 
        content: attr(data-label);
        position: absolute;
        right: 10px;
        top: 10px;
        font-weight: bold;
        color: #b30000;
      }
      
      td:last-child { 
        border-bottom: none; 
      }
      
      .popup-message, .update-date-popup,
      #locationPermission, #notificationsPopup,
      #emergencyPopup {
        width: 90%;
        padding: 20px;
      }
      
      .permission-buttons, .popup-buttons, #emergencyPopup .buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .permission-buttons button, .popup-buttons button,
      #emergencyPopup .buttons button {
        width: 100%;
      }
    }
    
    /* تحسينات للشاشات الصغيرة جداً */
    @media (max-width: 480px) {
      #welcome h1 {
        font-size: 22px;
      }
      
      #welcome .welcome-content {
        padding: 15px;
      }
      
      .input-icon i {
        right: 10px;
        font-size: 16px;
      }
      
      .input-icon input, .input-icon select {
        padding-right: 35px !important;
      }
    }
    
    /* تأثيرات إضافية */
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
  </style>
  <!-- CryptoJS for password hashing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfIBS2gB4lkRZ1_ZerLk451EVfafrfWSM&libraries=places&loading=async"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-messaging.js"></script>
</head>
<body>

<!-- مؤشر التحميل -->
<div id="loadingIndicator">
  <i class="fas fa-spinner fa-spin"></i>
  <p>جاري المعالجة...</p>
</div>

<!-- نافذة طلب إذن الموقع -->
<div id="locationPermission">
  <h3><i class="fas fa-map-marker-alt"></i> إذن الوصول إلى الموقع</h3>
  <p>لتتمكن من رؤية المتبرعين القريبين منك، نحتاج إلى إذنك للوصول إلى الموقع الحالي.</p>
  <p style="color: #2e7d32; font-weight: bold;">بموافقتك، يمكنك مساعدة المحتاجين للدم بسرعة أكبر!</p>
  <div class="permission-buttons">
    <button id="allowLocation" class="btn btn-secondary"><i class="fas fa-check"></i> الموافقة</button>
    <button id="denyLocation" class="btn btn-danger"><i class="fas fa-times"></i> رفض</button>
  </div>
</div>

<!-- نافذة الإشعارات -->
<div id="notificationsPopup">
  <h3><i class="fas fa-bell"></i> الإشعارات</h3>
  <div id="notificationsList">
    <div class="notification-item">
      <p>مرحباً بك في تطبيق قطرة أمل! شكراً لانضمامك لمجتمع المتبرعين بالدم.</p>
      <div class="notification-time"><i class="far fa-clock"></i> اليوم</div>
    </div>
  </div>
  <button id="btn-close-notifications" class="btn btn-outline"><i class="fas fa-times"></i> إغلاق</button>
</div>

<!-- نافذة طلب الطوارئ -->
<div id="emergencyPopup">
  <h3><i class="fas fa-exclamation-triangle"></i> طلب تبرع طارئ</h3>
  
  <div id="emergencyErrors" class="error-message"></div>
  
  <label for="emergencyBloodType"><i class="fas fa-tint"></i> فصيلة الدم المطلوبة</label>
  <select id="emergencyBloodType" class="input-icon">
    <i class="fas fa-chevron-down"></i>
    <option value="">اختر فصيلة الدم</option>
    <option>+A</option><option>-A</option>
    <option>+B</option><option>-B</option>
    <option>+AB</option><option>-AB</option>
    <option>+O</option><option>-O</option>
  </select>
  
  <label for="emergencyCity"><i class="fas fa-city"></i> المحافظة</label>
  <input type="text" id="emergencyCity" placeholder="المحافظة">
  
  <label for="emergencyArea"><i class="fas fa-map-marker-alt"></i> المديرية</label>
  <input type="text" id="emergencyArea" placeholder="المديرية">
  
  <label for="emergencyMessage"><i class="fas fa-comment"></i> رسالة الطلب (اختياري)</label>
  <textarea id="emergencyMessage" placeholder="مثال: حالة طارئة في مستشفى السلام، يرجى التبرع بالدم..."></textarea>
  
  <div class="buttons">
    <button id="btn-cancel-emergency" class="btn btn-outline"><i class="fas fa-times"></i> إلغاء</button>
    <button id="btn-send-emergency" class="btn btn-danger"><i class="fas fa-paper-plane"></i> إرسال</button>
  </div>
</div>

<!-- قسم الترحيب -->
<div id="welcome" class="section active">
  <div class="welcome-container">
    <h1>
      <i class="fas fa-tint pulse" style="color: #b30000;"></i> مرحبًا بكم في تطبيق قطرة أمل
    </h1>
    
    <div class="welcome-content">
      <h2>هدف التطبيق</h2>
      <p>
        تطبيق "قطرة أمل" هو مبادرة إنسانية تهدف إلى تسهيل عملية البحث عن المتبرعين بالدم وتوفير وسيلة اتصال سريعة بين المحتاجين والمتبرعين. 
        نسعى من خلال هذا التطبيق إلى إنقاذ حياة المرضى والمصابين الذين يحتاجون إلى نقل الدم بشكل عاجل.
      </p>
      
      <h3>مميزات التطبيق</h3>
      <ul>
        <li><i class="fas fa-user-plus"></i> تسجيل متبرعين جدد بسهولة</li>
        <li><i class="fas fa-search"></i> البحث عن متبرعين حسب فصيلة الدم والموقع</li>
        <li><i class="fas fa-map-marker-alt"></i> تحديد المتبرعين القريبين من موقعك</li>
        <li><i class="fas fa-phone"></i> التواصل المباشر مع المتبرعين عبر الهاتف أو الواتساب</li>
        <li><i class="fas fa-edit"></i> تحديث بيانات المتبرعين بسهولة</li>
        <li><i class="fas fa-bell"></i> إرسال إشعارات طارئة للمتبرعين عند الحاجة للدم</li>
      </ul>
      
      <div class="quote-box">
        <i class="fas fa-quote-left"></i>
        <p>قطرة دم واحدة يمكنها إنقاذ حياة... كن بطلاً وساهم في إنقاذ الأرواح</p>
      </div>
      
      <h3>كيف يعمل البحث عن متبرعين قريبين؟</h3>
      <p>
        عند الموافقة على مشاركة الموقع، يمكنك البحث عن المتبرعين الأقرب إليك جغرافياً. 
        هذا يساعد في توفير الوقت والجهد عند الحاجة الضرورية للدم، خاصة في الحالات الطارئة.
      </p>
    </div>
    
    <button id="btn-start-app">
      <i class="fas fa-sign-in-alt"></i> الدخول إلى التطبيق
    </button>
    
    <p style="margin-top: 20px; font-size: 14px; color: #666; line-height: 1.4;">
      <i class="fas fa-info-circle"></i> مصمم الموقع نبيل سالم اليافعي<br>
      <a class="whatsapp-link" href="https://wa.me/966511479262" target="_blank">
          <i class="fab fa-whatsapp"></i> 00966511479262 أضغط للتواصل مباشرة
      </a>
    </p>
  </div>
</div>

<header>
  <i class="fas fa-tint"></i> تطبيق قطرة أمل ... قطرة أمل تنقذ حياة
</header>

<p style="font-size: 17px; color: #333; line-height: 1.3; margin: 5px 0; font-weight: 600; text-align: center; display: none;">
  <i class="fas fa-info-circle"></i> تم تصميم هذا الموقع لربط المحتاجين بالمتبرعين مباشرة.
</p>

<nav>
  <button id="btn-show-register" class="btn"><i class="fas fa-user-plus"></i> تسجيل متبرع جديد</button>
  <button id="btn-show-password-popup" class="btn"><i class="fas fa-edit"></i> تعديل البيانات</button>
  <button id="btn-show-search" class="btn"><i class="fas fa-search"></i> بحث عن متبرع</button>
  <button id="btn-show-emergency" class="btn btn-danger"><i class="fas fa-exclamation-triangle"></i> طلب طارئ</button>
  <button id="btn-show-notifications" class="btn"><i class="fas fa-bell"></i> الإشعارات</button>
</nav>

<!-- قسم تسجيل المتبرعين -->
<div id="register" class="section">
  <h3><i class="fas fa-user-plus"></i> تسجيل متبرع جديد</h3>
  <p style="font-size: 15px; color: #b71c1c; line-height: 1.2; margin-top: 0; font-weight: 500;">
    <i class="fas fa-info-circle"></i> الرجاء تعبئة البيانات المطلوبة (مكانك الحالي)  
  </p>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-user"></i> الاسم الكامل</label>
    <div class="input-icon">
      <i class="fas fa-user"></i>
      <input type="text" id="donorName" placeholder="الاسم الكامل">
    </div>
  </div>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
    <div class="input-icon">
      <i class="fas fa-phone"></i>
      <input type="tel" id="donorPhone" class="phone-input" placeholder="رقم الهاتف" inputmode="numeric" dir="ltr">
    </div>
  </div>
  
  <div class="input-group">
    <label class="field-label"><i class="fab fa-whatsapp"></i> رقم الواتساب (اختياري)</label>
    <p style="font-size: 12px; color: #666; margin: 5px 0;">يجب أن يبدأ الرقم بـ 967 (مثال: 967712345678)</p>
    <div class="input-icon">
      <i class="fab fa-whatsapp"></i>
      <input type="tel" id="donorWhatsapp" class="whatsapp-input" placeholder="967712345678" inputmode="numeric" dir="ltr">
    </div>
  </div>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-city"></i> المحافظة</label>
    <div class="input-icon">
      <i class="fas fa-city"></i>
      <input type="text" id="donorCity" placeholder="المحافظة">
    </div>
  </div>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-map-marker-alt"></i> المديرية</label>
    <div class="input-icon">
      <i class="fas fa-map-marker-alt"></i>
      <input type="text" id="donorArea" placeholder="المديرية">
    </div>
  </div>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-home"></i> مكان السكن (اختياري)</label>
    <div class="input-icon">
      <i class="fas fa-home"></i>
      <input type="text" id="donorLocation" placeholder="مكان السكن">
    </div>
  </div>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-map-marked-alt"></i> تحديد الموقع</label>
    <p style="font-size: 12px; color: #666; margin: 5px 0;">اضغط على الزر أدناه لتحديد موقعك الحالي أو اسحب العلامة على الخريطة</p>
    <div id="locationPickerMap" class="map-container"></div>
    <button id="btn-get-current-location" type="button" class="btn btn-secondary">
      <i class="fas fa-location-arrow"></i> استخدام موقعي الحالي
    </button>
    <input type="hidden" id="donorLatitude">
    <input type="hidden" id="donorLongitude">
  </div>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-calendar-alt"></i> تاريخ آخر تبرع</label>
    <p style="font-size: 12px; color: #666; margin: 5px 0;">إذا لم تتبرع بعد اترك الحقل فارغاً</p>
    <div class="input-icon">
      <i class="far fa-calendar"></i>
      <input type="date" id="donorLastDate">
    </div>
  </div>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-tint"></i> فصيلة الدم</label>
    <div class="input-icon">
      <i class="fas fa-chevron-down"></i>
      <select id="donorBlood">
        <option disabled selected value="">اختر فصيلة دمك</option>
        <option>+A</option><option>-A</option>
        <option>+B</option><option>-B</option>
        <option>+AB</option><option>-AB</option>
        <option>+O</option><option>-O</option>
      </select>
    </div>
  </div>
  
  <button id="btn-add-donor" class="btn"><i class="fas fa-save"></i> تسجيل</button>
</div>

<!-- قسم تعديل البيانات -->
<div id="edit" class="section">
  <h3><i class="fas fa-edit"></i> تعديل بيانات متبرع</h3>
  
  <div class="input-group">
    <label class="field-label"><i class="fas fa-search"></i> البحث عن المتبرع</label>
    <div class="input-icon">
      <i class="fas fa-search"></i>
      <input type="text" id="editSearchInput" placeholder="ابحث باسم المتبرع أو رقمه">
    </div>
    <button id="btn-search-donor-edit" class="btn"><i class="fas fa-search"></i> بحث</button>
  </div>
  
  <div id="editSection" style="display:none;">
    <h4 style="margin: 20px 0 15px; color: #b30000; display: flex; align-items: center; gap: 10px;">
      <i class="fas fa-user-edit"></i> جاري تعديل بيانات المتبرع: <span id="editingDonorId" style="font-weight: bold;"></span>
    </h4>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-user"></i> الاسم الكامل</label>
      <div class="input-icon">
        <i class="fas fa-user"></i>
        <input type="text" id="editNewName" placeholder="الاسم الكامل">
      </div>
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-phone"></i> رقم الهاتف</label>
      <div class="input-icon">
        <i class="fas fa-phone"></i>
        <input type="tel" id="editPhone" class="phone-input" placeholder="رقم الهاتف" dir="ltr">
      </div>
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fab fa-whatsapp"></i> رقم الواتساب (اختياري)</label>
      <div class="input-icon">
        <i class="fab fa-whatsapp"></i>
        <input type="tel" id="editWhatsapp" class="whatsapp-input" placeholder="967712345678" dir="ltr">
      </div>
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-city"></i> المحافظة</label>
      <div class="input-icon">
        <i class="fas fa-city"></i>
        <input type="text" id="editCity" placeholder="المحافظة">
      </div>
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-map-marker-alt"></i> المديرية</label>
      <div class="input-icon">
        <i class="fas fa-map-marker-alt"></i>
        <input type="text" id="editArea" placeholder="المديرية">
      </div>
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-home"></i> مكان السكن (اختياري)</label>
      <div class="input-icon">
        <i class="fas fa-home"></i>
        <input type="text" id="editLocation" placeholder="مكان السكن">
      </div>
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-map-marked-alt"></i> تحديد الموقع</label>
      <p style="font-size: 12px; color: #666; margin: 5px 0;">اضغط على الزر أدناه لتحديث موقعك الحالي أو اسحب العلامة على الخريطة</p>
      <div id="editLocationPickerMap" class="map-container"></div>
      <button id="btn-get-edit-current-location" type="button" class="btn btn-secondary">
        <i class="fas fa-location-arrow"></i> استخدام موقعي الحالي
      </button>
      <input type="hidden" id="editDonorLatitude">
      <input type="hidden" id="editDonorLongitude">
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-calendar-alt"></i> تاريخ آخر تبرع</label>
      <div class="input-icon">
        <i class="far fa-calendar"></i>
        <input type="date" id="editLastDate">
      </div>
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-tint"></i> فصيلة الدم</label>
      <div class="input-icon">
        <i class="fas fa-chevron-down"></i>
        <select id="editBlood">
          <option>+A</option><option>-A</option>
          <option>+B</option><option>-B</option>
          <option>+AB</option><option>-AB</option>
          <option>+O</option><option>-O</option>
        </select>
      </div>
    </div>
    
    <div class="buttons-group" style="display: flex; gap: 10px; margin-top: 20px;">
      <button id="btn-save-edit" class="btn"><i class="fas fa-save"></i> حفظ التعديل</button>
      <button id="btn-delete-donor" class="btn btn-danger"><i class="fas fa-trash-alt"></i> حذف المتبرع</button>
      <button id="btn-cancel-edit" class="btn btn-outline"><i class="fas fa-times"></i> إلغاء</button>
    </div>
  </div>
</div>

<!-- قسم البحث عن المتبرعين -->
<div id="search" class="section">
  <h3><i class="fas fa-search"></i> البحث عن متبرعين</h3>
  <p style="font-size: 15px; color: #b71c1c; line-height: 1.2; margin-top: 0; font-weight: 500;">
    <i class="fas fa-info-circle"></i> للباحثين عن نوع فصيلة دم محددة
  </p>
  
  <div class="search-filters">
    <div class="input-group">
      <label class="field-label"><i class="fas fa-tint"></i> نوع الفصيلة</label>
      <div class="input-icon">
        <i class="fas fa-chevron-down"></i>
        <select id="searchBlood">
          <option value="">ابحث بنوع الفصيلة</option>
          <option>+A</option><option>-A</option>
          <option>+B</option><option>-B</option>
          <option>+AB</option><option>-AB</option>
          <option>+O</option><option>-O</option>
        </select>
      </div>
    </div>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-search"></i> بحث بالاسم أو الهاتف أو المنطقة</label>
      <div class="input-icon">
        <i class="fas fa-search"></i>
        <input type="text" id="searchQuery" placeholder="ابحث بالاسم أو الهاتف أو المنطقة">
      </div>
    </div>
    
    <div class="map-actions">
      <button id="btn-nearby-donors" class="btn btn-secondary">
        <i class="fas fa-location-arrow"></i> البحث عن متبرعين قريبين مني
      </button>
      
      <button id="btn-toggle-map" class="btn btn-outline" style="display: none;">
        <i class="fas fa-map"></i> عرض/إخفاء الخريطة
      </button>
    </div>
    
    <div id="donorsMap" class="map-container"></div>
  </div>
  
  <div id="donorCount" style="margin:20px 0;font-size:18px;font-weight:bold;color:#333;text-align:center;">
    <i class="fas fa-users"></i> عدد المتبرعين: <span>0</span>
  </div>
  
  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th><i class="fas fa-user"></i> الاسم</th>
          <th><i class="fas fa-phone"></i> الهاتف</th>
          <th><i class="fas fa-tint"></i> الفصيلة</th>
          <th><i class="fas fa-city"></i> المحافظة</th>
          <th><i class="fas fa-map-marker-alt"></i> المديرية</th>
          <th><i class="fas fa-home"></i> السكن</th>
          <th><i class="fab fa-whatsapp"></i> الواتساب</th>
          <th><i class="fas fa-calendar-alt"></i> آخر تبرع</th>
          <th><i class="fas fa-location-arrow"></i> المسافة</th>
          <th><i class="fas fa-edit"></i> تحديث آخر تبرع</th>
        </tr>
      </thead>
      <tbody id="donorsTable"></tbody>
    </table>
  </div>
</div>

<!-- النوافذ المنبثقة -->
<div id="successPopup" class="popup-overlay">
  <div class="popup-message">
    <div class="popup-icon success-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <h3>نجاح!</h3>
    <p id="successMessage"></p>
    <div class="popup-buttons">
      <button id="btn-close-success" class="btn btn-secondary"><i class="fas fa-check"></i> موافق</button>
    </div>
  </div>
</div>

<div id="errorPopup" class="popup-overlay">
  <div class="popup-message">
    <div class="popup-icon error-icon">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <h3>خطأ!</h3>
    <p id="errorMessage"></p>
    <div class="popup-buttons">
      <button id="btn-close-error" class="btn btn-danger"><i class="fas fa-times"></i> إغلاق</button>
    </div>
  </div>
</div>

<div id="passwordPopup" class="popup-overlay">
  <div class="popup-message">
    <div class="popup-icon">
      <i class="fas fa-lock"></i>
    </div>
    <h3>التحقق من الهوية</h3>
    <p>للدخول إلى قسم التعديل، يرجى إدخال كلمة المرور</p>
    
    <div class="input-group">
      <div class="input-icon">
        <i class="fas fa-key"></i>
        <input type="password" id="passwordInput" placeholder="كلمة المرور">
      </div>
    </div>
    
    <div id="passwordError" class="error-message"></div>
    
    <div class="popup-buttons">
      <button id="btn-check-password" class="btn btn-secondary"><i class="fas fa-check"></i> دخول</button>
      <button id="btn-close-password-popup" class="btn btn-outline"><i class="fas fa-times"></i> إغلاق</button>
    </div>
    
    <p style="font-size:12px;color:gray;margin-top:15px;">
      <i class="fas fa-info-circle"></i> للتعديل أو الحذف، تواصل على الواتس: 00966511479262 نبيل اليافعي
    </p>
  </div>
</div>

<div id="updateDatePopup" class="popup-overlay">
  <div class="popup-message">
    <div class="popup-icon">
      <i class="fas fa-calendar-check"></i>
    </div>
    <h3>تحديث بيانات المتبرع</h3>
    <p>جاري تحديث تاريخ التبرع للمتبرع: <strong id="updatingDonorName"></strong></p>
    
    <div class="input-group">
      <label class="field-label"><i class="fas fa-calendar-day"></i> تاريخ التبرع الجديد</label>
      <div class="input-icon">
        <i class="far fa-calendar"></i>
        <input type="date" id="newDonationDate">
      </div>
    </div>
    
    <div class="popup-buttons">
      <button id="btn-save-donation-date" class="btn btn-secondary"><i class="fas fa-save"></i> حفظ</button>
      <button id="btn-close-update-date-popup" class="btn btn-outline"><i class="fas fa-times"></i> إغلاق</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
  import { GeoPoint } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfIBS2gB4lkRZ1_ZerLk451EVfafrfWSM",
    authDomain: "qtratamal.firebaseapp.com",
    projectId: "qtratamal",
    storageBucket: "qtratamal.appspot.com",
    messagingSenderId: "491056452067",
    appId: "1:491056452067:web:0c8ef019a651cd47c290d6"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const messaging = getMessaging(app);

  let currentDonorDocId = null;
  let currentDisplayedDonors = [];
  let isProcessing = false;
  const pendingOperations = new Set();
  let map;
  let markers = [];
  let userPosition = null;
  let locationPermissionAsked = false;
  let mapInitialized = false;
  let locationPickerMap;
  let locationMarker;
  let editLocationPickerMap;
  let editLocationMarker;

  // كلمة المرور المشفرة
  const PASSWORD_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";

  // وظائف مساعدة
  function showLoading() {
    document.getElementById('loadingIndicator').style.display = 'flex';
  }

  function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
  }

  function disableButtons() {
    document.querySelectorAll('button').forEach(btn => {
      btn.disabled = true;
    });
  }

  function enableButtons() {
    document.querySelectorAll('button').forEach(btn => {
      btn.disabled = false;
    });
  }

  function showMessage(msg, type = 'success') {
    const popup = type === 'success' ? document.getElementById('successPopup') : document.getElementById('errorPopup');
    const messageElement = type === 'success' ? document.getElementById('successMessage') : document.getElementById('errorMessage');
    
    messageElement.textContent = msg;
    popup.style.display = 'flex';
    
    // إغلاق النافذة تلقائياً بعد 3 ثواني
    setTimeout(() => {
      if (popup.style.display === 'flex') {
        popup.style.display = 'none';
      }
    }, 3000);
  }

  function formatDate(dateString) {
    if (!dateString) return '—';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function normalizeArabic(text) {
    if (!text) return '';
    return text
      .toLowerCase()
      .trim()
      .replace(/[\u064B-\u065F]/g, '')
      .replace(/[\u0622\u0623\u0625]/g, 'ا')
      .replace(/ة/g, 'ه')
      .replace(/ى/g, 'ي')
      .replace(/\s+/g, ' ');
  }

  // دالة لتهيئة خريطة تحديد الموقع
  function initLocationPickerMap() {
    locationPickerMap = new google.maps.Map(document.getElementById('locationPickerMap'), {
      center: {lat: 15.3694, lng: 44.1910}, // مركز افتراضي (صنعاء)
      zoom: 12,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true
    });

    // إضافة علامة قابلة للسحب
    locationMarker = new google.maps.Marker({
      position: {lat: 15.3694, lng: 44.1910},
      map: locationPickerMap,
      draggable: true,
      title: "اسحب العلامة لتحديد موقعك الدقيق",
      animation: google.maps.Animation.DROP
    });

    // تحديث الإحداثيات عند تحريك العلامة
    locationMarker.addListener('dragend', function() {
      const position = locationMarker.getPosition();
      document.getElementById('donorLatitude').value = position.lat();
      document.getElementById('donorLongitude').value = position.lng();
    });

    // إمكانية النقر على الخريطة لتحديد الموقع
    locationPickerMap.addListener('click', function(e) {
      locationMarker.setPosition(e.latLng);
      document.getElementById('donorLatitude').value = e.latLng.lat();
      document.getElementById('donorLongitude').value = e.latLng.lng();
    });
  }

  // دالة لتهيئة خريطة تحديد الموقع في قسم التعديل
  function initEditLocationPickerMap(lat, lng) {
    editLocationPickerMap = new google.maps.Map(document.getElementById('editLocationPickerMap'), {
      center: {lat: lat || 15.3694, lng: lng || 44.1910},
      zoom: 12,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true
    });

    // إضافة علامة قابلة للسحب
    editLocationMarker = new google.maps.Marker({
      position: {lat: lat || 15.3694, lng: lng || 44.1910},
      map: editLocationPickerMap,
      draggable: true,
      title: "اسحب العلامة لتحديد موقعك الدقيق",
      animation: google.maps.Animation.DROP
    });

    // تحديث الإحداثيات عند تحريك العلامة
    editLocationMarker.addListener('dragend', function() {
      const position = editLocationMarker.getPosition();
      document.getElementById('editDonorLatitude').value = position.lat();
      document.getElementById('editDonorLongitude').value = position.lng();
    });

    // إمكانية النقر على الخريطة لتحديد الموقع
    editLocationPickerMap.addListener('click', function(e) {
      editLocationMarker.setPosition(e.latLng);
      document.getElementById('editDonorLatitude').value = e.latLng.lat();
      document.getElementById('editDonorLongitude').value = e.latLng.lng();
    });
  }

  // دالة لتهيئة الخريطة الرئيسية
  function initMap() {
    const mapDiv = document.getElementById('donorsMap');
    if (!mapDiv || mapDiv.style.display === 'none') return;
    
    if (!mapInitialized && typeof google !== 'undefined') {
      map = new google.maps.Map(mapDiv, {
        center: {lat: 15.3694, lng: 44.1910}, // إحداثيات صنعاء
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });
      
      mapInitialized = true;
      
      // طلب إذن الموقع عند تحميل الصفحة
      if (!locationPermissionAsked) {
        requestLocationPermission();
      }
    }
  }

  // دالة لطلب إذن الموقع
  function requestLocationPermission() {
    locationPermissionAsked = true;
    const permissionDiv = document.getElementById('locationPermission');
    
    // إظهار نافذة طلب الإذن فقط إذا لم يتم منح الإذن مسبقًا
    if (navigator.permissions) {
      navigator.permissions.query({name: 'geolocation'}).then(permissionStatus => {
        if (permissionStatus.state !== 'granted') {
          permissionDiv.style.display = 'block';
        }
      });
    } else {
      permissionDiv.style.display = 'block';
    }
  }

  // دالة لعرض المتبرعين على الخريطة
  async function displayDonorsOnMap(donors) {
    if (!mapInitialized || !map) {
      initMap();
      return;
    }
    
    // مسح العلامات القديمة أولاً
    clearMapMarkers();
    
    // إضافة علامة للمستخدم إذا كان لدينا موقعه
    if (userPosition) {
      new google.maps.Marker({
        position: userPosition,
        map: map,
        title: 'موقعك الحالي',
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        },
        animation: google.maps.Animation.DROP
      });
    }
    
    const bounds = new google.maps.LatLngBounds();
    
    // إضافة علامات للمتبرعين
    for (const donor of donors) {
      let donorLocation;
      
      if (donor.coordinates) {
        donorLocation = {
          lat: donor.coordinates.latitude,
          lng: donor.coordinates.longitude
        };
      } else {
        // للمتبرعين القدامى الذين لا يوجد لديهم إحداثيات
        donorLocation = {lat: 15.3694, lng: 44.1910}; // افتراضي لصنعاء
      }
      
      bounds.extend(donorLocation);
      
      const marker = new google.maps.Marker({
        position: donorLocation,
        map: map,
        title: donor.name,
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
        },
        animation: google.maps.Animation.DROP
      });
      
      markers.push(marker);
      
      // إضافة معلومات عند النقر على العلامة
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="direction: rtl; text-align: right; max-width: 250px;">
            <h3 style="margin: 0 0 10px 0; color: #b30000; font-size: 16px;">${donor.name}</h3>
            <p style="margin: 5px 0;"><strong style="color: #b30000;">فصيلة الدم:</strong> ${donor.blood}</p>
            <p style="margin: 5px 0;"><strong style="color: #b30000;">الهاتف:</strong> ${donor.phone}</p>
            ${donor.whatsapp ? `<p style="margin: 5px 0;"><strong style="color: #b30000;">واتساب:</strong> ${donor.whatsapp}</p>` : ''}
            <p style="margin: 5px 0;"><strong style="color: #b30000;">المحافظة:</strong> ${donor.city}</p>
            <p style="margin: 5px 0;"><strong style="color: #b30000;">المديرية:</strong> ${donor.area}</p>
            <div style="margin-top: 10px; display: flex; justify-content: center;">
              <a href="tel:${donor.phone}" style="color: white; background: #2e7d32; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-phone"></i> اتصل الآن
              </a>
            </div>
          </div>
        `
      });
      
      marker.addListener('click', () => {
        infoWindow.open(map, marker);
      });
    }
    
    if (donors.length > 0) {
      if (userPosition) {
        bounds.extend(userPosition);
      }
      map.fitBounds(bounds);
    }
  }

  // دالة لمسح العلامات من الخريطة
  function clearMapMarkers() {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
  }

  // دالة للحصول على الموقع الحالي
  function getCurrentLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject('متصفحك لا يدعم تحديد الموقع');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        position => {
          userPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          resolve(userPosition);
        },
        error => {
          let errorMessage = 'تعذر الحصول على موقعك';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'تم رفض طلب الوصول إلى الموقع';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'معلومات الموقع غير متوفرة';
              break;
            case error.TIMEOUT:
              errorMessage = 'انتهى وقت طلب الموقع';
              break;
          }
          reject(errorMessage);
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });
  }

  async function addDonor() {
    if (isProcessing) return;
    
    const donorName = document.getElementById('donorName').value.trim();
    const nameParts = donorName.split(/\s+/);
    const donorPhone = document.getElementById('donorPhone').value.trim();
    const btn = document.getElementById('btn-add-donor');
    
    // التحقق من التكرار المحلي أولاً
    if (pendingOperations.has(donorPhone)) {
      showMessage('جاري معالجة هذا المتبرع، يرجى الانتظار...', 'error');
      return;
    }

    if (nameParts.length < 2 || nameParts.length > 4) {
      showMessage("الاسم يجب أن يتكون من أسمين إلى أربعة أسماء فقط.", 'error');
      return;
    }
    
    const phoneRegex = /^[0-9]{9}$/;
    if (!phoneRegex.test(donorPhone)) {
      showMessage('رقم الهاتف يجب أن يتكون من 9 أرقام فقط', 'error');
      return;
    }
    
    const donorWhatsapp = document.getElementById('donorWhatsapp').value.trim();
    if (donorWhatsapp) {
      const whatsappRegex = /^967\d{9}$/;
      if (!whatsappRegex.test(donorWhatsapp)) {
        showMessage('رقم الواتساب يجب أن يبدأ بـ 967 ويتكون من 12 رقماً مثال: 967712345678', 'error');
        return;
      }
    }

    // التحقق من وجود إحداثيات
    const lat = document.getElementById('donorLatitude').value;
    const lng = document.getElementById('donorLongitude').value;
    
    if (!lat || !lng) {
      showMessage('الرجاء تحديد موقعك على الخريطة لتفعيل ميزة البحث عن المتبرعين القريبين', 'error');
      return;
    }

    try {
      isProcessing = true;
      pendingOperations.add(donorPhone);
      btn.disabled = true;
      showLoading();
      
      // التحقق من التكرار على السيرفر
      const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', donorPhone)));
      
      if (!phoneSnap.empty) {
        showMessage('رقم الهاتف مسجل بالفعل', 'error');
        return;
      }
      
      const city = document.getElementById('donorCity').value.trim();
      const area = document.getElementById('donorArea').value.trim();
      
      const d = {
        name: donorName,
        phone: donorPhone,
        city: city,
        area: area,
        location: document.getElementById('donorLocation').value.trim(),
        lastDate: document.getElementById('donorLastDate').value || null,
        whatsapp: donorWhatsapp || null,
        blood: document.getElementById('donorBlood').value,
        coordinates: new GeoPoint(parseFloat(lat), parseFloat(lng)),
        createdAt: new Date().toISOString()
      };
      
      if (!d.name || !d.phone || !d.city || !d.area || !d.blood) { 
        showMessage('يرجى تعبئة جميع الحقول الأساسية', 'error'); 
        return; 
      }

      const docRef = await addDoc(collection(db, 'donors'), d);
      
      // تسجيل رمز الإشعارات إذا كان موجوداً
      const fcmToken = localStorage.getItem('fcmToken');
      if (fcmToken) {
        await updateDoc(doc(db, 'donors', docRef.id), {
          notificationToken: fcmToken
        });
      }
      
      showMessage('تم تسجيل بياناتك بنجاح جزاك الله خير');
      document.querySelectorAll('#register input').forEach(i => i.value = '');
      document.getElementById('donorBlood').selectedIndex = 0;
      locationMarker.setPosition({lat: 15.3694, lng: 44.1910}); // إعادة العلامة للموقع الافتراضي
      document.getElementById('donorLatitude').value = '';
      document.getElementById('donorLongitude').value = '';
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء التسجيل', 'error');
    } finally {
      isProcessing = false;
      pendingOperations.delete(donorPhone);
      btn.disabled = false;
      hideLoading();
    }
  }

  async function searchDonorToEdit() {
    if (isProcessing) return;
    
    const input = document.getElementById('editSearchInput').value.trim();
    const btn = document.getElementById('btn-search-donor-edit');
    
    if (!input) { 
      showMessage('الرجاء إدخال الاسم أو رقم الهاتف', 'error'); 
      return; 
    }
    
    try {
      isProcessing = true;
      btn.disabled = true;
      showLoading();
      
      const snap = await getDocs(collection(db, 'donors'));
      const all = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const normInput = normalizeArabic(input);
      const found = all.find(d => {
        const normName = normalizeArabic(d.name || '');
        const normPhone = normalizeArabic(d.phone || '');
        return normName === normInput || normPhone === normInput;
      });
      
      if (found) {
        currentDonorDocId = found.id;
        document.getElementById('editingDonorId').textContent = found.id;
        document.getElementById('editSection').style.display = 'block';
        document.getElementById('editNewName').value = found.name;
        document.getElementById('editPhone').value = found.phone;
        document.getElementById('editWhatsapp').value = found.whatsapp || '';
        document.getElementById('editCity').value = found.city;
        document.getElementById('editArea').value = found.area;
        document.getElementById('editLocation').value = found.location || '';
        document.getElementById('editLastDate').value = found.lastDate || '';
        document.getElementById('editBlood').value = found.blood;
        
        // تهيئة خريطة التعديل بالإحداثيات الحالية
        const lat = found.coordinates?.latitude || 15.3694;
        const lng = found.coordinates?.longitude || 44.1910;
        initEditLocationPickerMap(lat, lng);
        document.getElementById('editDonorLatitude').value = lat;
        document.getElementById('editDonorLongitude').value = lng;
      } else {
        showMessage('المتبرع غير موجود', 'error');
      }
    } catch (e) { 
      console.error(e); 
      showMessage('خطأ أثناء البحث', 'error'); 
    } finally {
      isProcessing = false;
      btn.disabled = false;
      hideLoading();
    }
  }

  async function saveEdit() {
    if (isProcessing || !currentDonorDocId) return;
    
    const btn = document.getElementById('btn-save-edit');
    const city = document.getElementById('editCity').value.trim();
    const area = document.getElementById('editArea').value.trim();
    
    // التحقق من وجود إحداثيات
    const lat = document.getElementById('editDonorLatitude').value;
    const lng = document.getElementById('editDonorLongitude').value;
    
    if (!lat || !lng) {
      showMessage('الرجاء تحديد موقعك على الخريطة', 'error');
      return;
    }

    try {
      isProcessing = true;
      btn.disabled = true;
      showLoading();
      
      const updated = {
        name: document.getElementById('editNewName').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        city: city,
        area: area,
        location: document.getElementById('editLocation').value.trim(),
        lastDate: document.getElementById('editLastDate').value || null,
        whatsapp: document.getElementById('editWhatsapp').value.trim() || null,
        blood: document.getElementById('editBlood').value,
        coordinates: new GeoPoint(parseFloat(lat), parseFloat(lng)),
        updatedAt: new Date().toISOString()
      };
      
      if (updated.whatsapp) {
        const whatsappRegex = /^967\d{9}$/;
        if (!whatsappRegex.test(updated.whatsapp)) {
          showMessage('رقم الواتساب يجب أن يبدأ بـ 967 ويتكون من 12 رقماً مثال: 967712345678', 'error');
          return;
        }
      }
      
      // التحقق من التكرار في الأسماء
      const nameSnap = await getDocs(query(collection(db, 'donors'), where('name', '==', updated.name)));
      if (!nameSnap.empty && nameSnap.docs.some(doc => doc.id !== currentDonorDocId)) { 
        showMessage('هذا الاسم مسجل لمتبرع آخر', 'error'); 
        return; 
      }
      
      // التحقق من التكرار في أرقام الهاتف
      const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', updated.phone)));
      if (!phoneSnap.empty && phoneSnap.docs.some(doc => doc.id !== currentDonorDocId)) { 
        showMessage('رقم الهاتف مسجل لمتبرع آخر', 'error'); 
        return; 
      }
      
      await updateDoc(doc(db, 'donors', currentDonorDocId), updated);
      showMessage('تم التعديل بنجاح');
      document.getElementById('editSection').style.display = 'none'; 
      currentDonorDocId = null;
    } catch (e) { 
      console.error(e); 
      showMessage('خطأ أثناء الحفظ', 'error'); 
    } finally {
      isProcessing = false;
      btn.disabled = false;
      hideLoading();
    }
  }

  async function deleteDonor() { 
    if (isProcessing || !currentDonorDocId) return;
    if (!confirm('هل أنت متأكد من حذف هذا المتبرع؟')) return;
    
    const btn = document.getElementById('btn-delete-donor');
    
    try {
      isProcessing = true;
      btn.disabled = true;
      showLoading();
      
      await deleteDoc(doc(db, 'donors', currentDonorDocId)); 
      showMessage('تم حذف المتبرع بنجاح');
      document.getElementById('editSection').style.display = 'none'; 
      currentDonorDocId = null;
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء الحذف', 'error');
    } finally {
      isProcessing = false;
      btn.disabled = false;
      hideLoading();
    }
  }

  function cancelEdit() { 
    document.getElementById('editSection').style.display = 'none'; 
    currentDonorDocId = null; 
  }

  function renderSearchTable(donors) {
    const tbody = document.getElementById('donorsTable'); 
    tbody.innerHTML = '';
    
    if (!donors.length) { 
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;">لا يوجد متبرعون</td></tr>'; 
      document.getElementById('donorCount').innerHTML = '<i class="fas fa-users"></i> عدد المتبرعين: <span>0</span>'; 
      currentDisplayedDonors = []; 
      return; 
    }
    
    currentDisplayedDonors = donors; 
    document.getElementById('donorCount').innerHTML = `<i class="fas fa-users"></i> عدد المتبرعين: <span>${donors.length}</span>`;
    
    donors.forEach(d => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td data-label="الاسم">${d.name}</td>
        <td data-label="الهاتف">
          <div style="display:flex;flex-direction:column;align-items:center;gap:5px;">
            <a href="tel:${d.phone}" style="color:white;background-color:#1b5e20;padding:5px 10px;border-radius:8px;display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-weight:bold;font-size:12px;white-space:nowrap;">
              <i class="fas fa-phone"></i>
              اضغط للإتصال
            </a>
           <span style="color:#b30000;font-weight:bold;direction:ltr;text-align:right;font-family:monospace;font-size:18px;">${d.phone}</span>
          </div>
        </td> 
        <td data-label="الفصيلة">${d.blood}</td>
        <td data-label="المحافظة">${d.city}</td>
        <td data-label="المديرية">${d.area}</td>
        <td data-label="السكن">${d.location || '—'}</td>
        <td data-label="الواتساب">
          ${d.whatsapp
            ? `<a href="https://wa.me/${d.whatsapp}" target="_blank"
                  style="color:green; text-decoration:none; font-weight:bold;
                         display:flex; flex-direction:column; align-items:center;
                         font-size: 0.95em;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <i class="fab fa-whatsapp" style="font-size:1.2em;"></i>
                    <span>${d.whatsapp}</span>
                  </div>
                  <small style="color:#006400; font-weight:normal; margin-top:5px; font-size:13px;">
                    اضغط للتواصل واتساب مباشرة
                  </small>
               </a>`
            : "—"
          }
        </td>
        <td data-label="آخر تبرع">${d.lastDate ? formatDate(d.lastDate) : '—'}</td>
        <td data-label="المسافة">${d.distance ? `<i class="fas fa-location-arrow"></i> ${d.distance}` : '—'}</td>
        <td data-label="تعديل">
          <button data-donor-id="${d.id}" class="btn-update-date">
            <i class="fas fa-edit"></i> تحديث تاريخ التبرع
          </button>
        </td>
      `;
    });
    
    document.querySelectorAll('.btn-update-date').forEach(btn => {
      btn.addEventListener('click', () => enableEditDate(btn.getAttribute('data-donor-id')));
    });
    
    // عرض المتبرعين على الخريطة إذا كانت الخريطة ظاهرة
    if (document.getElementById('donorsMap').style.display !== 'none') {
      displayDonorsOnMap(donors);
    }
  }

  async function searchDonors() {
    if (isProcessing) return;
    
    const blood = document.getElementById('searchBlood').value;
    const text = normalizeArabic(document.getElementById('searchQuery').value);
    
    try {
      isProcessing = true;
      showLoading();
      
      let q = collection(db, 'donors');
      if (blood) q = query(q, where('blood', '==', blood));
      
      const snap = await getDocs(q);
      let donors = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      // تطبيق البحث النصي
      if (text) {
        donors = donors.filter(d => {
          const fields = [d.name, d.phone, d.city, d.area, d.location].map(f => normalizeArabic(f || ''));
          return fields.some(f => f.includes(text));
        });
      }
      
      renderSearchTable(donors);
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء البحث', 'error');
    } finally {
      isProcessing = false;
      hideLoading();
    }
  }

  async function searchNearbyDonors() {
    try {
      showLoading();
      
      // الحصول على الموقع الحالي
      const position = await getCurrentLocation();
      
      const snap = await getDocs(collection(db, 'donors'));
      const allDonors = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      // حساب المسافة لكل متبرع
      const donorsWithDistance = allDonors.map(donor => {
        let distance = '—';
        
        if (donor.coordinates) {
          const donorPos = {
            lat: donor.coordinates.latitude,
            lng: donor.coordinates.longitude
          };
          distance = calculateDistance(position, donorPos);
        }
        
        return {
          ...donor,
          distance: distance
        };
      });
      
      // تصفية المتبرعين القريبين (على سبيل المثال ضمن 50 كم)
      const nearbyDonors = donorsWithDistance.filter(donor => {
        return donor.distance !== '—' && parseFloat(donor.distance) < 50;
      });
      
      renderSearchTable(nearbyDonors.length > 0 ? nearbyDonors : donorsWithDistance);
      showMessage(nearbyDonors.length > 0 
        ? `تم العثور على ${nearbyDonors.length} متبرع قريب منك` 
        : 'لا يوجد متبرعون قريبون، عرض جميع المتبرعين');
      
    } catch (error) {
      console.error('Error getting nearby donors:', error);
      showMessage(error, 'error');
    } finally {
      hideLoading();
    }
  }

  // دالة لحساب المسافة بين موقعين
  function calculateDistance(pos1, pos2) {
    const R = 6371; // نصف قطر الأرض بالكيلومتر
    const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
    const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(pos1.lat * Math.PI / 180) * 
      Math.cos(pos2.lat * Math.PI / 180) * 
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return (R * c).toFixed(1) + ' كم';
  }

  function enableEditDate(id) { 
    currentDonorDocId = id; 
    const donor = currentDisplayedDonors.find(d => d.id === id);
    document.getElementById('updatingDonorName').textContent = donor?.name || '';
    document.getElementById('updateDatePopup').style.display = 'flex'; 
    document.getElementById('newDonationDate').value = ''; 
  }

  async function saveDonationDate() {
    if (isProcessing) return;
    
    const newDate = document.getElementById('newDonationDate').value;
    const btn = document.getElementById('btn-save-donation-date');
    
    if (!newDate) { 
      showMessage('يرجى إدخال تاريخ التبرع', 'error'); 
      return; 
    }
    
    try { 
      isProcessing = true;
      btn.disabled = true;
      showLoading();
      
      await updateDoc(doc(db, 'donors', currentDonorDocId), { 
        lastDate: newDate,
        updatedAt: new Date().toISOString()
      }); 
      
      showMessage('تم تحديث بيانات المتبرع بنجاح');
      
      // تحديث الجدول مباشرة
      const donorIndex = currentDisplayedDonors.findIndex(d => d.id === currentDonorDocId);
      if (donorIndex !== -1) {
        currentDisplayedDonors[donorIndex].lastDate = newDate;
        renderSearchTable(currentDisplayedDonors);
      }
      
      closeUpdateDatePopup(); 
      currentDonorDocId = null; 
    } catch(e) { 
      console.error('Error updating donor data:', e); 
      showMessage('حدث خطأ أثناء التحديث', 'error'); 
    } finally {
      isProcessing = false;
      btn.disabled = false;
      hideLoading();
    }
  }

  function closeUpdateDatePopup() { 
    document.getElementById('updateDatePopup').style.display = 'none'; 
    currentDonorDocId = null; 
  }

  function showPasswordPopup() { 
    document.getElementById('passwordPopup').style.display = 'flex'; 
    document.getElementById('passwordInput').value = ''; 
    document.getElementById('passwordError').style.display = 'none';
  }

  function closePasswordPopup() { 
    document.getElementById('passwordPopup').style.display = 'none'; 
    document.getElementById('passwordError').style.display = 'none';
  }

  function showEmergencyPopup() {
    document.getElementById('emergencyPopup').style.display = 'block';
    document.getElementById('emergencyErrors').style.display = 'none';
  }

  function closeEmergencyPopup() {
    document.getElementById('emergencyPopup').style.display = 'none';
  }

  async function showNotifications() {
    const notificationsPopup = document.getElementById('notificationsPopup');
    notificationsPopup.style.display = 'block';
    
    try {
      showLoading();
      const snap = await getDocs(collection(db, 'emergencyRequests'));
      const notificationsList = document.getElementById('notificationsList');
      notificationsList.innerHTML = '';
      
      snap.docs.forEach(doc => {
        const data = doc.data();
        const notificationItem = document.createElement('div');
        notificationItem.className = 'notification-item';
        notificationItem.innerHTML = `
          <p><strong>طلب طارئ لفصيلة ${data.bloodType}</strong></p>
          <p>${data.city} - ${data.area}</p>
          ${data.message ? `<p>${data.message}</p>` : ''}
          <div class="notification-time"><i class="far fa-clock"></i> ${formatDate(data.timestamp)}</div>
        `;
        notificationsList.appendChild(notificationItem);
      });
    } catch (error) {
      console.error('Error fetching notifications:', error);
      showMessage('حدث خطأ أثناء جلب الإشعارات', 'error');
    } finally {
      hideLoading();
    }
  }

  function closeNotifications() {
    const notificationsPopup = document.getElementById('notificationsPopup');
    notificationsPopup.style.display = 'none';
  }

  async function checkPassword() { 
    const inputPassword = document.getElementById('passwordInput').value;
    const errorElement = document.getElementById('passwordError');
    
    if (!inputPassword) {
      errorElement.textContent = 'يرجى إدخال كلمة المرور';
      errorElement.style.display = 'block';
      return;
    }
    
    // حساب التجزئة SHA-256 لكلمة المرور المدخلة
    const hashedInput = CryptoJS.SHA256(inputPassword).toString();
    
    if (hashedInput === PASSWORD_HASH) { 
      closePasswordPopup(); 
      showSection('edit'); 
      errorElement.style.display = 'none';
    } else {
      errorElement.textContent = 'كلمة المرور غير صحيحة';
      errorElement.style.display = 'block';
      errorElement.classList.add('shake');
      setTimeout(() => errorElement.classList.remove('shake'), 500);
    }
  }

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // إظهار/إخفاء عناصر التصفح حسب القسم النشط
    const nav = document.querySelector('nav');
    const header = document.querySelector('header');
    const infoP = document.querySelector('header + p');
    
    if (id === 'welcome') {
      nav.style.display = 'none';
      header.style.display = 'none';
      infoP.style.display = 'none';
    } else {
      nav.style.display = 'flex';
      header.style.display = 'block';
      infoP.style.display = 'block';
      
      if (id === 'search') {
        searchDonors();
      }
      if (id === 'register') {
        document.querySelectorAll('#register input').forEach(i => i.value = '');
        document.getElementById('donorBlood').selectedIndex = 0;
      }
      if (id === 'edit') {
        document.getElementById('editSection').style.display = 'none';
        document.getElementById('editSearchInput').value = '';
        currentDonorDocId = null;
        document.getElementById('editingDonorId').textContent = '';
      }
    }
  }

  // دالة للتحقق من المتبرع الحالي وتحديث موقعه
  async function checkAndUpdateCurrentDonor() {
    try {
      // الحصول على الموقع الحالي
      const position = await getCurrentLocation();
      
      // البحث عن المتبرع الحالي باستخدام رقم الهاتف
      const phone = prompt('الرجاء إدخال رقم هاتفك المسجل في التطبيق للتحقق من هويتك:');
      if (!phone) return;
      
      const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', phone)));
      
      if (phoneSnap.empty) {
        showMessage('رقم الهاتف غير مسجل في التطبيق', 'error');
        return;
      }
      
      const donorDoc = phoneSnap.docs[0];
      const donorData = donorDoc.data();
      
      // تحديث موقع المتبرع
      await updateDoc(doc(db, 'donors', donorDoc.id), {
        coordinates: new GeoPoint(position.lat, position.lng),
        updatedAt: new Date().toISOString()
      });
      
      showMessage('تم تحديث موقعك بنجاح. شكراً لك على مساهمتك في إنقاذ الأرواح!');
      
    } catch (error) {
      console.error('Error updating donor location:', error);
      showMessage('حدث خطأ أثناء تحديث الموقع', 'error');
    }
  }

  // دالة لإرسال إشعارات الطوارئ للمتبرعين المناسبين
  async function sendEmergencyNotification(bloodType, city, area, message) {
    try {
      showLoading();
      
      // البحث عن المتبرعين المناسبين
      const q = query(
        collection(db, 'donors'),
        where('blood', '==', bloodType),
        where('city', '==', city),
        where('area', '==', area)
      );
      
      const donorsSnap = await getDocs(q);
      
      if (donorsSnap.empty) {
        showMessage('لا يوجد متبرعون مسجلون في منطقتك بنفس فصيلة الدم المطلوبة', 'error');
        return;
      }
      
      // إعداد بيانات الإشعار
      const notificationTitle = `طلب تبرع طارئ لفصيلة ${bloodType}`;
      const notificationBody = message || `حالة طارئة في ${city} - ${area}. يرجى التبرع بالدم إذا أمكن.`;
      
      // إرسال إشعار لكل متبرع مناسب
      const promises = [];
      
      donorsSnap.forEach(doc => {
        const donor = doc.data();
        if (donor.notificationToken) {
          // هنا يمكنك استخدام خدمة خارجية لإرسال الإشعارات الفورية
          // مثل Firebase Cloud Functions أو خدمة إرسال إشعارات مخصصة
          promises.push(
            fetch('https://fcm.googleapis.com/fcm/send', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'key=AAAAYOUR_SERVER_KEY_HERE'
              },
              body: JSON.stringify({
                to: donor.notificationToken,
                notification: {
                  title: notificationTitle,
                  body: notificationBody,
                  icon: '/icons/icon-192x192.png',
                  click_action: window.location.origin
                },
                data: {
                  bloodType,
                  city,
                  area,
                  message,
                  timestamp: new Date().toISOString()
                }
              })
            })
          );
        }
      });
      
      await Promise.all(promises);
      showMessage(`تم إرسال الإشعارات إلى ${donorsSnap.size} متبرع`);
      
    } catch (error) {
      console.error('Error sending notifications:', error);
      showMessage('حدث خطأ أثناء إرسال الإشعارات', 'error');
    } finally {
      hideLoading();
    }
  }

  // دالة لإرسال طلب تبرع طارئ
  async function sendEmergencyRequest() {
    const bloodType = document.getElementById('emergencyBloodType').value;
    const city = document.getElementById('emergencyCity').value.trim();
    const area = document.getElementById('emergencyArea').value.trim();
    const message = document.getElementById('emergencyMessage').value.trim();
    const errorsElement = document.getElementById('emergencyErrors');
    
    // إخفاء رسائل الخطأ السابقة
    errorsElement.style.display = 'none';
    errorsElement.innerHTML = '';
    
    // التحقق من صحة البيانات
    let isValid = true;
    let errorMessages = [];
    
    if (!bloodType) {
      isValid = false;
      errorMessages.push('الرجاء تحديد فصيلة الدم المطلوبة');
    }
    
    if (!city) {
      isValid = false;
      errorMessages.push('الرجاء تحديد المحافظة');
    }
    
    if (!area) {
      isValid = false;
      errorMessages.push('الرجاء تحديد المديرية');
    }
    
    if (!isValid) {
      errorsElement.innerHTML = errorMessages.map(msg => `<p>${msg}</p>`).join('');
      errorsElement.style.display = 'block';
      errorsElement.classList.add('shake');
      setTimeout(() => errorsElement.classList.remove('shake'), 500);
      return;
    }
    
    try {
      showLoading();
      
      // 1. حفظ الطلب في قاعدة البيانات
      const emergencyData = {
        bloodType,
        city,
        area,
        message: message || "حالة طارئة تحتاج إلى تبرع بالدم",
        timestamp: new Date().toISOString(),
        status: "pending"
      };
      
      const docRef = await addDoc(collection(db, 'emergencyRequests'), emergencyData);
      
      // 2. إرسال إشعارات للمتبرعين المناسبين
      await sendEmergencyNotification(bloodType, city, area, message);
      
      // 3. إضافة الإشعار محلياً
      const notificationItem = document.createElement('div');
      notificationItem.className = 'notification-item';
      notificationItem.innerHTML = `
        <p><strong>طلب طارئ لفصيلة ${bloodType}</strong></p>
        <p>${city} - ${area}</p>
        ${message ? `<p>${message}</p>` : ''}
        <div class="notification-time"><i class="far fa-clock"></i> الآن</div>
      `;
      document.getElementById('notificationsList').prepend(notificationItem);
      
      showMessage(`تم إرسال الطلب بنجاح وسيتم التواصل مع المتبرعين`);
      closeEmergencyPopup();
      
    } catch (error) {
      console.error('Error sending emergency request:', error);
      
      // عرض رسالة الخطأ في الواجهة
      errorsElement.innerHTML = '<p>حدث خطأ أثناء إرسال الطلب. يرجى المحاولة مرة أخرى لاحقاً.</p>';
      errorsElement.style.display = 'block';
      errorsElement.classList.add('shake');
      setTimeout(() => errorsElement.classList.remove('shake'), 500);
      
    } finally {
      hideLoading();
    }
  }

  // دالة لتهيئة إشعارات Firebase
  async function initializeFirebaseMessaging() {
    try {
      // التحقق من دعم Service Worker
      if (!('serviceWorker' in navigator)) {
        console.log('Service Worker غير مدعوم في هذا المتصفح');
        return;
      }
      
      // التحقق من دعم الإشعارات
      if (!('Notification' in window)) {
        console.log('الإشعارات غير مدعومة في هذا المتصفح');
        return;
      }
      
      // تسجيل خدمة العامل (Service Worker)
      const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
      console.log('Service Worker registered:', registration);
      
      // طلب إذن الإشعارات
      const permission = await Notification.requestPermission();
      
      if (permission === 'granted') {
        console.log('Notification permission granted.');
        
        // الحصول على رمز الجهاز
        const token = await getToken(messaging, {
          vapidKey: 'BL_RSy08zoTm4ShAVn5xlGj6Q9jdykvhuMTBICVs010LybRd9CF-vf9uDPkwu_8LN67j3hqt7X7m87iAlbO3Qs0',
          serviceWorkerRegistration: registration
        });
        
        if (token) {
          console.log('FCM Token:', token);
          localStorage.setItem('fcmToken', token);
          
          // إذا كان المستخدم متبرعاً مسجلاً، قم بتحديث سجله في قاعدة البيانات
          const phone = prompt('إذا كنت متبرعاً مسجلاً، الرجاء إدخال رقم هاتفك لتحديث رمز الإشعار:');
          if (phone) {
            const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', phone)));
            if (!phoneSnap.empty) {
              const donorDoc = phoneSnap.docs[0];
              await updateDoc(doc(db, 'donors', donorDoc.id), {
                notificationToken: token,
                updatedAt: new Date().toISOString()
              });
              showMessage('تم تحديث بيانات الإشعارات بنجاح');
            }
          }
        }
        
        // استقبال الإشعارات عندما يكون التطبيق مفتوحاً
        onMessage(messaging, (payload) => {
          console.log('Message received:', payload);
          
          // إضافة الإشعار إلى قائمة الإشعارات المحلية
          const notificationItem = document.createElement('div');
          notificationItem.className = 'notification-item';
          notificationItem.innerHTML = `
            <p><strong>${payload.notification?.title || 'إشعار جديد'}</strong></p>
            <p>${payload.notification?.body || 'لديك طلب تبرع طارئ'}</p>
            <div class="notification-time"><i class="far fa-clock"></i> الآن</div>
          `;
          
          document.getElementById('notificationsList').prepend(notificationItem);
          
          // عرض الإشعار كرسالة منبثقة
          showMessage(payload.notification?.body || 'لديك إشعار جديد', 'success');
        });
      } else {
        console.log('Unable to get permission to notify.');
        showMessage('لن تتمكن من تلقي إشعارات الطوارئ بدون إذن الإشعارات', 'error');
      }
    } catch (error) {
      console.error('Error initializing Firebase Messaging:', error);
      showMessage('حدث خطأ أثناء تهيئة نظام الإشعارات', 'error');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // أحداث النوافذ المنبثقة
    document.getElementById('btn-close-success').addEventListener('click', () => {
      document.getElementById('successPopup').style.display = 'none';
    });
    
    document.getElementById('btn-close-error').addEventListener('click', () => {
      document.getElementById('errorPopup').style.display = 'none';
    });
    
    // أحداث التنقل
    document.getElementById('btn-show-register').addEventListener('click', () => showSection('register'));
    document.getElementById('btn-show-password-popup').addEventListener('click', showPasswordPopup);
    document.getElementById('btn-show-search').addEventListener('click', () => showSection('search'));
    document.getElementById('btn-show-emergency').addEventListener('click', showEmergencyPopup);
    document.getElementById('btn-show-notifications').addEventListener('click', showNotifications);
    
    // أحداث النماذج
    document.getElementById('btn-add-donor').addEventListener('click', addDonor);
    document.getElementById('btn-search-donor-edit').addEventListener('click', searchDonorToEdit);
    document.getElementById('btn-save-edit').addEventListener('click', saveEdit);
    document.getElementById('btn-delete-donor').addEventListener('click', deleteDonor);
    document.getElementById('btn-cancel-edit').addEventListener('click', cancelEdit);
    document.getElementById('btn-check-password').addEventListener('click', checkPassword);
    document.getElementById('btn-close-password-popup').addEventListener('click', closePasswordPopup);
    document.getElementById('btn-close-notifications').addEventListener('click', closeNotifications);
    document.getElementById('btn-send-emergency').addEventListener('click', sendEmergencyRequest);
    document.getElementById('btn-cancel-emergency').addEventListener('click', closeEmergencyPopup);
    document.getElementById('searchBlood').addEventListener('change', searchDonors);
    document.getElementById('searchQuery').addEventListener('input', searchDonors);
    document.getElementById('btn-save-donation-date').addEventListener('click', saveDonationDate);
    document.getElementById('btn-close-update-date-popup').addEventListener('click', closeUpdateDatePopup);
    document.getElementById('btn-nearby-donors').addEventListener('click', searchNearbyDonors);
    document.getElementById('btn-toggle-map').addEventListener('click', () => {
      const mapDiv = document.getElementById('donorsMap');
      mapDiv.style.display = mapDiv.style.display === 'none' ? 'block' : 'none';
      
      if (mapDiv.style.display === 'block') {
        initMap();
        if (currentDisplayedDonors.length > 0) {
          displayDonorsOnMap(currentDisplayedDonors);
        }
      }
    });
    document.getElementById('btn-start-app').addEventListener('click', () => showSection('register'));
    
    // أحداث استخدام الموقع الحالي
    document.getElementById('btn-get-current-location').addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          locationMarker.setPosition(userLocation);
          locationPickerMap.setCenter(userLocation);
          document.getElementById('donorLatitude').value = userLocation.lat;
          document.getElementById('donorLongitude').value = userLocation.lng;
        }, function(error) {
          showMessage('تعذر الحصول على موقعك الحالي. يرجى تحديد الموقع يدوياً على الخريطة.', 'error');
        });
      } else {
        showMessage('متصفحك لا يدعم تحديد الموقع. يرجى تحديد الموقع يدوياً على الخريطة.', 'error');
      }
    });

    document.getElementById('btn-get-edit-current-location').addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          editLocationMarker.setPosition(userLocation);
          editLocationPickerMap.setCenter(userLocation);
          document.getElementById('editDonorLatitude').value = userLocation.lat;
          document.getElementById('editDonorLongitude').value = userLocation.lng;
        }, function(error) {
          showMessage('تعذر الحصول على موقعك الحالي. يرجى تحديد الموقع يدوياً على الخريطة.', 'error');
        });
      } else {
        showMessage('متصفحك لا يدعم تحديد الموقع. يرجى تحديد الموقع يدوياً على الخريطة.', 'error');
      }
    });
    
    // أحداث نافذة طلب إذن الموقع
    document.getElementById('allowLocation').addEventListener('click', async () => {
      document.getElementById('locationPermission').style.display = 'none';
      
      try {
        // الحصول على الموقع الحالي بعد منح الإذن
        const position = await getCurrentLocation();
        
        // عرض رسالة تأكيد للمستخدم
        const confirmUpdate = confirm('هل ترغب في تحديث موقعك الحالي في قاعدة البيانات إذا كنت متبرعاً مسجلاً؟');
        
        if (confirmUpdate) {
          // استدعاء دالة التحقق والتحديث
          await checkAndUpdateCurrentDonor();
        } else {
          showMessage('تم منح إذن الوصول إلى الموقع. يمكنك الآن استخدام زر "البحث عن متبرعين قريبين"', 'success');
        }
      } catch (error) {
        console.error('Error getting location:', error);
        showMessage('تم منح إذن الوصول إلى الموقع. يمكنك الآن استخدام زر "البحث عن متبرعين قريبين"', 'success');
      }
    });
    
    document.getElementById('denyLocation').addEventListener('click', () => {
      document.getElementById('locationPermission').style.display = 'none';
      showMessage('لن تتمكن من رؤية المتبرعين القريبين منك بدون إذن الموقع', 'error');
    });
    
    // إظهار قسم الترحيب عند تحميل الصفحة
    showSection('welcome');
    
    // تهيئة إشعارات Firebase
    initializeFirebaseMessaging();
    
    // التحقق من تحميل Google Maps API بشكل دوري
    let mapCheckInterval = setInterval(() => {
      if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
        clearInterval(mapCheckInterval);
        initMap();
        initLocationPickerMap();
      }
    }, 100);
  });
</script>

</body>
</html>
